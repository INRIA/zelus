<!DOCTYPE html>
<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="./css/bootstrap.min.css"            rel="stylesheet">
<link href="./css/zelus.css"                    rel="stylesheet">
<link href="./css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="./css/zelus-src.css"                rel="stylesheet">
<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="./js/html5shiv.js"></script>
<![endif]-->

<title>Zélus: examples</title>
<meta name="description" content="Example programs written in Zélus.">
<meta name="author" content="Timothy Bourke and Marc Pouzet">
</head>

<body data-spy="scroll" data-target=".sidebar-nav">


<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="brand" href="index.html">Zélus</a>
      <div class="nav-collapse collapse">
        <ul class="nav">
          <li id="title-download"><a href="download.html">Download</a></li>
          <li id="title-examples"><a href="examples.html">Examples</a></li>
          <li id="title-papers"><a href="papers.html">Publications</a></li>
          <li id="title-contact"><a href="contact.html">Contact</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>

<script>
window.onload = function() {
document.getElementById('title-examples').className = 'active';
};
</script>

<div class="container-fluid">
<div class="row-fluid">
<div class="span3 hidden-print">
<div class="well sidebar-nav" data-spy="affix">
<ul class="nav nav-list">

<li class="sidebar-nav-header">Related</li>
<li><a href="http://www.di.ens.fr/ParkasTeam.html">PARKAS Team</a></li>


<li class="sidebar-nav-header">Example code</li>
<li><a href="#bouncingball">Bouncing ball</a></li>
<li><a href="#bangbang">Bang-Bang Temperature Control</a></li>
<li><a href="#soas_relaycontrol">Self-Oscillating Adaptive System</a></li>
<li><a href="#stickysprings">Sticky Masses</a></li>
<li><a href="#backhoe">Backhoe</a></li>
<li><a href="#airtraffic">Airtraffic Control</a></li>
</ul>
</div><!--/.well -->
</div><!--/span-->
<div class="span9 maintext">
<h1>Examples</h1>
<div id="bouncingball" class="example-section">
<h2 id="bouncingball">Bouncing ball</h2>

<p>A slight variation of the classic bouncing ball model: a ball bouncing down
a set of steps. The instants of impact are detected using zero crossings,
<code>up(ground(x) -. y)</code>, which trigger a reset of the balls vertical velocity
to -0.8 its previous value.</p>

<p><img src="img/bouncingball.png" alt="Screenshot" title="Screenshot" id="screenshot" /></p>

<p>In the basic version of the program, the ball ‘falls through the floor’
due to limited floating-point precision.</p>

<div id="bouncingball-ball-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#bouncingball-ball-box"
   href="#bouncingball-ball"><i class="icon-file"></i> ball.zls</a>
</div>

<div id="bouncingball-ball" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(** Bouncing ball. *)</span>

<span class="comment">(* [ground x] returns the position in [y] *)</span>
<span class="keyword ">let</span> <span class="">ground</span> <span class="">x</span> = <span class="constructor">World</span>.<span class="">ground</span>(<span class="">x</span>)
<span class="keyword ">let</span> <span class="">ground_abs</span> <span class="">x</span> = <span class="constructor">World</span>.<span class="">ground_abs</span>(<span class="">x</span>)

<span class="keyword ">let</span> <span class="">x_0</span> = <span class="number">0.0</span>
<span class="keyword ">let</span> <span class="">y_0</span> = <span class="number">8.0</span>
<span class="keyword ">let</span> <span class="">x_v</span> = <span class="number">0.72</span>
<span class="keyword ">let</span> <span class="">g</span> = <span class="number">9.81</span>
<span class="keyword ">let</span> <span class="">loose</span> = <span class="number">0.8</span>

<span class="comment">(* The bouncing ball *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">ball</span>(<span class="">x</span>, <span class="">y_0</span>) = (<span class="">y</span>, <span class="">y_v</span>, <span class="">z</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span>
      <span class="keyword ">der</span> <span class="">y</span> = <span class="">y_v</span> <span class="keyword ">init</span> <span class="">y_0</span>
  <span class="keyword ">and</span> 
      <span class="keyword ">der</span> <span class="">y_v</span> = -. <span class="">g</span> <span class="keyword ">init</span> <span class="number">0.0</span> <span class="keyword ">reset</span> <span class="">z</span> -&gt; (-. <span class="">loose</span> <span class="operator">*.</span> <span class="keyword expr ">last</span> <span class="">y_v</span>)
  <span class="keyword ">and</span> <span class="">z</span> = <span class="keyword expr ">up</span>(<span class="">ground</span>(<span class="">x</span>) -. <span class="">y</span>)

  
<span class="comment">(* Main entry point *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () =
  <span class="keyword ">let</span> <span class="keyword ">der</span> <span class="">x</span> = <span class="">x_v</span> <span class="keyword ">init</span> <span class="">x_0</span> <span class="keyword ">in</span>
  <span class="keyword ">let</span> (<span class="">y</span>, _, <span class="">z</span>) = <span class="">ball</span>(<span class="">x</span>, <span class="">y_0</span>) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">ok</span> = <span class="keyword ">present</span> (<span class="keyword expr ">period</span> (<span class="number">0.04</span>)) -&gt; () | <span class="">z</span> -&gt; () <span class="keyword ">in</span>
  <span class="keyword ">present</span> <span class="">ok</span>() -&gt; <span class="constructor">Showball</span>.<span class="">show</span> (<span class="">x</span> <span class="keyword expr ">fby</span> <span class="">x</span>, <span class="">y</span> <span class="keyword expr ">fby</span> <span class="">y</span>, <span class="">x</span>, <span class="">y</span>);
  ()

</code></pre></div></div></div></div>

<p>With hybrid automata, it is instead possible to switch to a sliding dynamic
when the balls vertical velocity becomes very small.</p>

<div id="bouncingball-autoball-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#bouncingball-autoball-box"
   href="#bouncingball-autoball"><i class="icon-file"></i> autoball.zls</a>
</div>

<div id="bouncingball-autoball" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(** The same as the bouncing ball, this time with a mean *)</span>
<span class="comment">(* to avoid crossing the ground *)</span>

<span class="comment">(* [ground x] returns the position in [y] *)</span>
<span class="keyword ">let</span> <span class="">ground</span> <span class="">x</span> = <span class="constructor">World</span>.<span class="">ground</span>(<span class="">x</span>)
<span class="keyword ">let</span> <span class="">ground_abs</span> <span class="">x</span> = <span class="constructor">World</span>.<span class="">ground_abs</span>(<span class="">x</span>)

<span class="keyword ">let</span> <span class="">x_0</span> = <span class="number">0.0</span>
<span class="keyword ">let</span> <span class="">y_0</span> = <span class="number">8.0</span>
<span class="keyword ">let</span> <span class="">x_v</span> = <span class="number">0.72</span>
<span class="keyword ">let</span> <span class="">eps</span> = <span class="number">0.01</span>

<span class="comment">(* The bouncing ball with two modes. *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">ball</span>(<span class="">x_0</span>, <span class="">y_0</span>) = (<span class="">x</span>, <span class="">y</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">y_start</span> = <span class="">y_0</span> 
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x</span> = <span class="">x_v</span> <span class="keyword ">init</span> <span class="">x_0</span>
  <span class="keyword ">and</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">Bouncing</span> -&gt;
      <span class="comment">(* the ball is falling with a possible bound. *)</span>
      <span class="keyword ">local</span> <span class="">z</span>, <span class="">y_v</span> <span class="keyword ">in</span>
      <span class="keyword ">do</span>
        (<span class="">y</span>, <span class="">y_v</span>, <span class="">z</span>) = <span class="constructor">Ball</span>.<span class="">ball</span>(<span class="">x</span>, <span class="">y_start</span>)
      <span class="keyword ">until</span> <span class="">z</span> <span class="keyword expr ">on</span> (<span class="">y_v</span> &lt; <span class="">eps</span>) <span class="keyword ">then</span> <span class="constructor">Sliding</span>(<span class="">ground</span>(<span class="">x</span>))
  | <span class="constructor">Sliding</span>(<span class="">y0</span>) -&gt;
      <span class="comment">(* the ball is fixed, i.e., the derivative for y is 0 *)</span>
      <span class="keyword ">do</span> 
        <span class="">y</span> = <span class="">y0</span> 
      <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">x</span> -. <span class="">ground_abs</span> <span class="">x</span>)
        <span class="comment">(* up(y -. eps -. ground(x)) *)</span>
      <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">y_start</span> = <span class="number">0.0</span> <span class="keyword ">in</span> <span class="constructor">Bouncing</span>
  <span class="keyword ">end</span>
  
<span class="comment">(* Main entry point *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () =
  <span class="keyword ">let</span> (<span class="">x</span>, <span class="">y</span>) = <span class="">ball</span>(<span class="">x_0</span>, <span class="">y_0</span>) <span class="keyword ">in</span>
  <span class="keyword ">present</span> (<span class="keyword expr ">period</span> (<span class="number">0.04</span>)) -&gt; <span class="constructor">Showball</span>.<span class="">show</span>(<span class="">x</span> <span class="keyword expr ">fby</span> <span class="">x</span>, <span class="">y</span> <span class="keyword expr ">fby</span> <span class="">y</span>, <span class="">x</span>, <span class="">y</span>);
  ()

</code></pre></div></div></div></div>
</div><hr />
<div id="bangbang" class="example-section">
<h2 id="bang-bangtemperaturecontrol">Bang-Bang Temperature Control</h2>

<div class="requirements">
<p class="text-info">
<i class="icon-info-sign"></i> <em>Requires</em>:
Lablgtk2</p>
</p>
</div>

<p>This model is a reimplementation of the Mathworks Simulink example
<a href="http://www.mathworks.com/help/simulink/examples/bang-bang-control-using-temporal-logic.html"><em>Bang-Bang Control Using Temporal Logic</em></a>.
The main differences with the original model are:</p>

<ul>
<li><p>We manually track the bias and slope for integers representing rational
values.</p></li>
<li><p>We use int for the integer values rather than int8.</p></li>
</ul>

<p>The top level of this example comprises three nodes:</p>

<p><img src="img/bangbang-model.png" alt="Model" title="Model" id="model" /></p>

<h3 id="controller">Controller</h3>

<p>The controller is discrete. It takes two inputs:</p>

<ul>
<li><p><em>reference temperature</em></p>

<p>This value is a constant 20°C, but it is encoded as a fixed-point integer
so that it can be compared directly with the digital temperature value
from the environment model. The reference temperature has a value
between 0 (-15°C) and 255 (84.609375°C), i.e., a resolution of
0.390625 per bit (0.390625 = 5 / 256 / 0.05).</p></li>
<li><p><em>feedback temperature</em></p>

<p>A digital temperature measurement.</p></li>
</ul>

<p>And provides two outputs:</p>

<ul>
<li><p><em>led</em>: the colour of a light emitting diode on the outside of the
controller:</p>

<ul>
<li><code>0</code> = <code>off</code>,</li>
<li><code>1</code> = <code>red</code> (not heating),</li>
<li><code>2</code> = <code>green</code> (heating).</li>
</ul></li>
<li><p><em>boiler</em>: a signal that switches the boiler on (<code>1</code>) or off (<code>0</code>).</p></li>
</ul>

<p>The main part of the controller is an automaton with two top-level states:</p>

<ul>
<li><p><code>Off</code>: The boiler is off. The LED is flashed red at 0.1 Hz (5 secs off, 5
secs red).</p></li>
<li><p><code>On</code>: The boiler is on. The LED is flashed red at 0.5 Hz (1 sec off, 1 sec
green).</p></li>
</ul>

<p>The controller always remains in the <code>Off</code> state for at least 40 seconds,
after which it will switch to the <code>On</code> state if the temperature is less than
the reference temperature.</p>

<p>The controller may not remain in the <code>On</code> state for more than 20 seconds. It
will switch to the <code>Off</code> state if the temperature becomes greater than the
reference temperature.</p>

<p>The on state contains an internal automaton that stays in a <code>High</code> state from
<code>t = 0</code> until the very first time that the measured temperature exceeds the
reference temperature (this is ensured by entry-by-history from <code>Off</code>). The
reason for this additional complication in the original Stateflow controller
is not clear; perhaps the intent was to heat at a faster rate the first time
the system is switched on? In our model, the effect is to delay an exit from
the <code>On</code> state by one reaction the first time the reference temperature is
attained.</p>

<h3 id="boiler">Boiler</h3>

<p>Boiler is a hybrid model of the boiler temperature and a digital
thermometer.</p>

<p>The boiler temperature is modeled by a single integrator with an initial
value of 15°C. This value (cools) at a rate of -0.1 / 25 when the
boiler is off. It changes (heats) at a rate of 1.0 / 25 when the boiler is
on.</p>

<p>The digital thermometer is modelled in some detail. Effectively, it takes a
floating point temperature value in degrees centigrade and returns an
integer between 0 and 255 representing that value (see the discussion above
for the reference temperature).</p>

<p>The sensor itself has a bias of 0.75 and and a precision of 0.05, i.e., the
output voltage V is a function of the temperature T: <code>V = 0.05 * T + 0.75</code>. An
analog-to-digital converter (ADC) converts this voltage into an integer. By
scaling, quantization, and limiting.</p>

<h3 id="scope">Scope</h3>

<p>Scope is a discrete node. It is triggered every <code>sample_period</code> to plot the
LED output, the boiler command, and the actual temperature against time.</p>

<p>Note that, even though all of these signals are continuous, they are plotted
at discrete instants (as plotting is a side-effect) and the graph is thus
(linearly) interpolated.</p>

<h3 id="simulation">Simulation</h3>

<p><img src="img/bangbang-graph.png" alt="Simulation" title="Simulation" id="simulation" /></p>

<p>The simulation output shows a staircased increase in temperature from 15°C
at <code>t = 0</code> to the 20°C just before <code>t = 500</code>. The initial rising edges have a
slope of 1.0/25 (the heating rate) and a duration of 20 seconds (the maximum
amount of time in the <code>On</code> state). The initial falling edges have a slope of
0.1/25 (the cooling rate) and a duration of 40 seconds (the minimum amount
of time in the <code>Off</code> state). After reaching the reference temperature, the
controller switches on and off to oscillate around the set-point.</p>

<p>The LED will flash green (<code>2</code>) during periods of heating, and red (<code>1</code>) during
periods of cooling, i.e., when not heating.</p>

<div id="bangbang-bangbang-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#bangbang-bangbang-box"
   href="#bangbang-bangbang"><i class="icon-file"></i> bangbang.zls</a>
</div>

<div id="bangbang-bangbang" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
  Version of the Mathworks Simulink example:
      Bang-Bang Control Using Temporal Logic
 *)</span>

<span class="comment">(* ** library functions ** *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">integrator</span> (<span class="">i</span>, <span class="">u</span>) = <span class="">y</span> <span class="keyword ">where</span>
  <span class="keyword ">der</span> <span class="">y</span> = <span class="">u</span> <span class="keyword ">init</span> <span class="">i</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">round</span> <span class="">x</span> = <span class="">floor</span> (<span class="">x</span> <span class="operator">+.</span> <span class="number">0.5</span>)

<span class="comment">(* ** model of analog-to-digital convertor ** *)</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">quantize</span> (<span class="">q</span>, <span class="">u</span>) = <span class="">q</span> <span class="operator">*.</span> <span class="">round</span>(<span class="">u</span> <span class="operator">/.</span> <span class="">q</span>)

<span class="comment">(* limiting without zero-crossings *)</span>
<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">limit</span> (<span class="">min</span>, <span class="">max</span>, <span class="">x</span>) =
  <span class="keyword ">if</span> <span class="">x</span> <span class="operator">>=</span> <span class="">max</span> <span class="keyword ">then</span> <span class="">max</span>
  <span class="keyword ">else</span> <span class="keyword ">if</span> <span class="">x</span> <span class="operator"><=</span> <span class="">min</span> <span class="keyword ">then</span> <span class="">min</span>
  <span class="keyword ">else</span> <span class="">x</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">adc</span> (<span class="">v</span>) = <span class="">pcm</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">vs</span> = <span class="">v</span> <span class="operator">*.</span> (<span class="number">256.0</span> <span class="operator">/.</span> <span class="number">5.0</span>)
  <span class="keyword ">and</span> <span class="">pcm</span> = <span class="">quantize</span> (<span class="number">1.0</span>, <span class="">limit</span> (<span class="number">0.0</span>, <span class="number">255.0</span>, <span class="">vs</span>))

<span class="comment">(* ** model of digital thermometer ** *)</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">digital_thermometer</span> (<span class="">temp</span>) = <span class="">int_of_float</span>(<span class="">adv</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">voltage</span> = <span class="number">0.05</span> <span class="operator">*.</span> <span class="">temp</span> <span class="operator">+.</span> <span class="number">0.75</span>
  <span class="keyword ">and</span> <span class="">adv</span> = <span class="">adc</span> (<span class="">voltage</span>)

<span class="comment">(* signed fixed-point int from scale and bias *)</span>
<span class="keyword ">let</span> <span class="keyword ">discrete</span> <span class="">fixdt</span> (<span class="">s</span>, <span class="">b</span>, <span class="">v</span>) = <span class="">int_of_float</span> ((<span class="">v</span> -. <span class="">b</span>) <span class="operator">/.</span> <span class="">s</span>)

<span class="comment">(* ** model of boiler plant with an exponential ** *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">boiler_exponential</span>(<span class="">k1</span>, <span class="">k2</span>, <span class="">is_on</span>) = <span class="">actual_temp</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">actual_temp</span> = 
           <span class="comment">(* two modes. [is_on] is a boolean and will only change *)</span>
           <span class="comment">(* at a zero-crossing instant. *)</span>
           <span class="keyword ">if</span> <span class="">is_on</span> <span class="keyword ">then</span> <span class="">k1</span> -. <span class="">k2</span> <span class="operator">*.</span> <span class="">actual_temp</span>
           <span class="keyword ">else</span> -. <span class="">k2</span> <span class="operator">*.</span> <span class="">actual_temp</span>
         <span class="keyword ">init</span> <span class="number">15.0</span>

<span class="comment">(* the one below is the Simulink version with an approximation by a *)</span>
<span class="comment">(* linear function *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">boiler</span>(<span class="">is_on</span>) = <span class="">actual_temp</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">actual_temp</span> = 
           <span class="comment">(* two modes. [is_on] is a boolean and will only change *)</span>
           <span class="comment">(* at a zero-crossing instant. *)</span>
           (<span class="keyword ">if</span> <span class="">is_on</span> <span class="keyword ">then</span> <span class="number">1.0</span> <span class="keyword ">else</span> -<span class="number">0.1</span>) <span class="operator">/.</span> <span class="number">25.0</span>
         <span class="keyword ">init</span> <span class="number">15.0</span>

<span class="comment">(* ** Bang-Bang Controller ** *)</span>

<span class="keyword ">let</span> <span class="">off</span>   = <span class="number">0</span>
<span class="keyword ">let</span> <span class="">red</span>   = <span class="number">1</span>
<span class="keyword ">let</span> <span class="">green</span> = <span class="number">2</span>

<span class="keyword ">let</span> <span class="">b_off</span>  = <span class="keyword constant ">false</span>
<span class="keyword ">let</span> <span class="">b_on</span>   = <span class="keyword constant ">true</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">after</span> (<span class="">x</span>) =
  <span class="keyword ">let</span> <span class="keyword ">rec</span> <span class="">c</span> = <span class="">x</span> <span class="keyword expr ">fby</span> <span class="">max</span> (<span class="number">0</span>, <span class="">c</span> - <span class="number">1</span>) <span class="keyword ">in</span>
  <span class="">c</span> = <span class="number">0</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">at</span> (<span class="">x</span>) =
  <span class="keyword ">let</span> <span class="keyword ">rec</span> <span class="">c</span> = <span class="number">0</span> <span class="keyword expr ">fby</span> ((<span class="">c</span> <span class="operator">+</span> <span class="number">1</span>) <span class="keyword operator ">mod</span> <span class="">x</span>) <span class="keyword ">in</span>
  <span class="keyword constant ">false</span> -&gt; (<span class="">c</span> = <span class="number">0</span>)

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">flash_led</span> (<span class="">color</span>, <span class="">delay</span>) = <span class="">led</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">Off</span> -&gt; <span class="keyword ">do</span> <span class="">led</span> = <span class="">off</span>   <span class="keyword ">until</span> (<span class="">after</span> <span class="">delay</span>) <span class="keyword ">then</span> <span class="constructor">On</span>
  | <span class="constructor">On</span>  -&gt; <span class="keyword ">do</span> <span class="">led</span> = <span class="">color</span> <span class="keyword ">until</span> (<span class="">after</span> <span class="">delay</span>) <span class="keyword ">then</span> <span class="constructor">Off</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">controller</span> (<span class="">ref</span>, <span class="">temp</span>) = (<span class="">led</span>, <span class="">boiler</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">cold</span> = <span class="">temp</span> <span class="operator"><=</span> <span class="">ref</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
  | <span class="constructor">Off</span> -&gt;
      <span class="keyword ">do</span> <span class="">boiler</span> = <span class="">b_off</span>
      <span class="keyword ">and</span> <span class="">led</span> = <span class="">flash_led</span> (<span class="">red</span>, <span class="number">5</span>)
      <span class="keyword ">until</span> (<span class="">after</span> <span class="number">40</span>) &amp; <span class="">cold</span> <span class="keyword ">then</span> <span class="constructor">On</span>
  | <span class="constructor">On</span> -&gt;
      <span class="keyword ">do</span> <span class="">boiler</span> = <span class="">b_on</span>
      <span class="keyword ">and</span> <span class="">led</span> = <span class="">flash_led</span> (<span class="">green</span>, <span class="number">1</span>)
      <span class="keyword ">until</span> (<span class="">not</span> <span class="">cold</span>) <span class="keyword ">then</span> <span class="constructor">Off</span>
      <span class="keyword ">else</span>  (<span class="">at</span> <span class="number">20</span>) <span class="keyword ">then</span> <span class="constructor">Off</span>

<span class="comment">(* ** main ** *)</span>

<span class="keyword ">let</span> <span class="">reference</span> = <span class="">fixdt</span> (<span class="number">5.0</span> <span class="operator">/.</span> <span class="number">256.0</span> <span class="operator">/.</span> <span class="number">0.05</span>, -. <span class="number">0.75</span> <span class="operator">/.</span> <span class="number">0.05</span>, <span class="number">20.0</span>)

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">model</span> () = (<span class="">led</span>, <span class="">on_off</span>, <span class="">actual_temp</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">trigger</span> = <span class="keyword expr ">period</span> (<span class="number">1.0</span>)

  <span class="keyword ">and</span> (<span class="">led</span>, <span class="">on_off</span>) = 
           <span class="keyword ">present</span> <span class="">trigger</span> -&gt; <span class="">controller</span>(<span class="">reference</span>, <span class="keyword expr ">last</span> <span class="">digital_temp</span>) 
      <span class="keyword ">init</span> (<span class="">red</span>, <span class="keyword constant ">false</span>)
  <span class="keyword ">and</span> <span class="">actual_temp</span> = <span class="">boiler</span>(<span class="">on_off</span>)
  <span class="keyword ">and</span> <span class="">digital_temp</span> = 
         <span class="keyword ">present</span> <span class="">trigger</span> -&gt; <span class="">digital_thermometer</span> (<span class="">actual_temp</span>)
      <span class="keyword ">init</span> <span class="number">0</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Scope</span> <span class="comment">(* Dump *)</span>
<span class="keyword ">let</span> <span class="">sample_period</span> = <span class="number">1.0</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">bool_to_float</span>(<span class="">x</span>) = <span class="keyword ">if</span> <span class="">x</span> <span class="keyword ">then</span> <span class="number">1.0</span> <span class="keyword ">else</span> <span class="number">0.0</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">plot</span> (<span class="">led</span>, <span class="">boiler</span>, <span class="">temp</span>) =
  <span class="keyword ">let</span> <span class="">s1</span> =
    <span class="">scope</span> (<span class="number">0.0</span>, <span class="number">2.0</span>, (<span class="string">"led (0=OFF, 1=RED, 2=GREEN)"</span>, <span class="">points</span> <span class="keyword constant ">true</span>, <span class="">float</span>(<span class="">led</span>))) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">s2</span> =
    <span class="">scope</span> (<span class="number">0.0</span>, <span class="number">1.0</span>, (<span class="string">"boiler (0=OFF, 1=ON)"</span>, <span class="">points</span> <span class="keyword constant ">true</span>, <span class="">bool_to_float</span>(<span class="">boiler</span>))) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">s3</span> =
    <span class="">scope</span> (<span class="number">11.0</span>, <span class="number">25.0</span>, (<span class="string">"temperature (degC)"</span>, <span class="">linear</span>, <span class="">temp</span>)) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="keyword ">rec</span> <span class="">t</span> = <span class="number">0.0</span> <span class="keyword expr ">fby</span> <span class="">t</span> <span class="operator">+.</span> <span class="">sample_period</span> <span class="keyword ">in</span>
  <span class="">window3</span> (<span class="string">"bangbang"</span>, <span class="number">600.0</span>, <span class="">t</span>, <span class="">s1</span>, <span class="">s2</span>, <span class="">s3</span>)

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () =
  <span class="keyword ">let</span> (<span class="">led</span>, <span class="">on_off</span>, <span class="">actual_temp</span>) = <span class="">model</span> () <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">trigger</span> = <span class="keyword expr ">period</span> (<span class="number">0.5</span>) <span class="keyword ">in</span>
  <span class="keyword ">present</span> <span class="">trigger</span> -&gt; <span class="">plot</span> (<span class="">led</span>, <span class="">on_off</span>, <span class="">actual_temp</span>) <span class="keyword ">else</span> ()

</code></pre></div></div></div></div>
</div><hr />
<div id="soas_relaycontrol" class="example-section">
<h2 id="self-oscillatingadaptivesystem">Self-Oscillating Adaptive System</h2>

<div class="requirements">
<p class="text-info">
<i class="icon-info-sign"></i> <em>Requires</em>:
Lablgtk2</p>
</p>
</div>

<p>This example comes from Chapter 10 of Åström and Wittenmark's
<a href="http://store.doverpublications.com/0486462781.html"><em>Adaptive Control</em></a>
(2nd edition).</p>

<p>It involves the control of a simple process using adaptive relay feedback.
Together, the process and relay incite <a href="http://ocw.mit.edu/courses/mathematics/18-03-differential-equations-spring-2010/video-lectures/lecture-32-limit-cycles/">limit cycle
oscillations</a>,
giving systems with high feedback loop gain.</p>

<p>Three variations of the system are developed.
The shared elements are incorporated into a single file:</p>

<div id="soas_relaycontrol-soas-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#soas_relaycontrol-soas-box"
   href="#soas_relaycontrol-soas"><i class="icon-file"></i> soas.zls</a>
</div>

<div id="soas_relaycontrol-soas" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
    Example 10.2 (A basic SOAS)
    from <span class="string">"Adaptive Control"</span>, 2e, Åström and Wittenmark, 2008

 *)</span>

<span class="comment">(* ** library functions ** *)</span>

<span class="comment">(* linear first-order single-input single-output system *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">siso_1o</span> (<span class="">a</span>, <span class="">b</span>, <span class="">c</span>, <span class="">d</span>, <span class="">u</span>) = <span class="">y</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">x1</span> = <span class="">a</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">b</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">d</span> <span class="operator">*.</span> <span class="">u</span>

<span class="comment">(* linear second-order single-input single-output system *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">siso_2o</span> ((<span class="">a11</span>, <span class="">a12</span>, <span class="">a21</span>, <span class="">a22</span>), (<span class="">b1</span>, <span class="">b2</span>), (<span class="">c1</span>, <span class="">c2</span>), <span class="">d</span>, <span class="">u</span>) = <span class="">y</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">x1</span> = <span class="">a11</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">a12</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">b1</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> = <span class="">a21</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">a22</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">b2</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c1</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">c2</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">d</span> <span class="operator">*.</span> <span class="">u</span>

<span class="comment">(* linear third-order single-input single-output system *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">siso_3o</span> ((<span class="">a11</span>, <span class="">a12</span>, <span class="">a13</span>, <span class="">a21</span>, <span class="">a22</span>, <span class="">a23</span>, <span class="">a31</span>, <span class="">a32</span>, <span class="">a33</span>),
                    (<span class="">b1</span>, <span class="">b2</span>, <span class="">b3</span>), (<span class="">c1</span>, <span class="">c2</span>, <span class="">c3</span>), <span class="">d</span>, <span class="">u</span>) = <span class="">y</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">x1</span> = <span class="">a11</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">a12</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">a13</span> <span class="operator">*.</span> <span class="">x3</span>  <span class="operator">+.</span>  <span class="">b1</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> = <span class="">a21</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">a22</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">a23</span> <span class="operator">*.</span> <span class="">x3</span>  <span class="operator">+.</span>  <span class="">b2</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x3</span> = <span class="">a31</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">a32</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">a33</span> <span class="operator">*.</span> <span class="">x3</span>  <span class="operator">+.</span>  <span class="">b3</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c1</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  <span class="">c2</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">c3</span> <span class="operator">*.</span> <span class="">x3</span>  <span class="operator">+.</span>  <span class="">d</span> <span class="operator">*.</span> <span class="">u</span>

<span class="comment">(* The initial state should be Low when e < 0 *)</span>
<span class="comment">(* ideal relay model *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">relay</span> (<span class="">d</span>, <span class="">e</span>) = <span class="">u</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">High</span> -&gt; <span class="keyword ">do</span> <span class="">u</span> = <span class="">d</span>    <span class="keyword ">until</span> <span class="keyword expr ">up</span>(-. <span class="">e</span>) <span class="keyword ">then</span> <span class="constructor">Low</span>
  | <span class="constructor">Low</span>  -&gt; <span class="keyword ">do</span> <span class="">u</span> = -. <span class="">d</span> <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">e</span>)    <span class="keyword ">then</span> <span class="constructor">High</span>

<span class="comment">(* ** model ** *)</span>

<span class="comment">(* feed-forward reference model

   damping factor z    = 0.7;
   natural frequency w = 1.0 rad/sec;

   The state-space realization can be calculated in Matlab:
      [A, B, C, D] = ord2(1.0, 0.7)

   Or in Scilab:
      s = %s; wn = 1.0; zeta = 0.7;
      tf2ss(syslin(<span class="character">'c'</span>, wn^2, s^2 + 2*zeta*wn*s + wn^2))
*)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">reference</span> <span class="">u</span> =
  <span class="">siso_2o</span> ((<span class="number">0.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.4</span>), (<span class="number">0.0</span>, <span class="number">1.0</span>), (<span class="number">1.0</span>, <span class="number">0.0</span>), <span class="number">0.0</span>, <span class="">u</span>)

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">command</span> () = <span class="">u</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">S0</span> -&gt; <span class="keyword ">do</span> <span class="">u</span> = <span class="number">1.0</span>  <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">17.5</span>)) <span class="keyword ">then</span> <span class="constructor">S1</span>
  | <span class="constructor">S1</span> -&gt; <span class="keyword ">do</span> <span class="">u</span> = -<span class="number">1.0</span> <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">17.5</span>)) <span class="keyword ">then</span> <span class="constructor">S2</span>
  | <span class="constructor">S2</span> -&gt; <span class="keyword ">do</span> <span class="">u</span> = <span class="number">1.0</span> <span class="keyword ">done</span>

<span class="comment">(* compensation network
                       s + 5
     G_f(s) = 1.2 * ( -------- )
                       s + 15

   The state-space realization can be calculated in Matlab:
     [a, b, c, d] = ss(1.2 * tf([1 5], [1 15]))

   or in Scilab:
     s = poly(0, <span class="character">'s'</span>)
     [a, b, c, d] = abcd(tf2ss(1.2 * (s + 5) / (s + 15)))

*)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">g_f</span> <span class="">u</span> = <span class="">siso_1o</span> (-<span class="number">15.0</span>, <span class="number">4.0</span>, -<span class="number">3.0</span>, <span class="number">1.2</span>, <span class="">u</span>)

<span class="comment">(* up-logic gain changer *)</span>
<span class="comment">(* The initial state should be D1 when |e| > e_l *)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">gain_changer</span> (<span class="">d1</span>, <span class="">d2</span>, <span class="">e_l</span>, <span class="">e</span>) = <span class="">d</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">D2</span> -&gt; <span class="keyword ">local</span> <span class="">t</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span>
            <span class="keyword ">der</span> <span class="">t</span> = <span class="number">1.0</span> <span class="keyword ">init</span> <span class="number">0.0</span>
            <span class="keyword ">and</span> <span class="">d</span> = <span class="">d2</span> <span class="operator">+.</span> (<span class="">d1</span> -. <span class="">d2</span>) <span class="operator">*.</span> <span class="">exp</span>(-.<span class="">t</span>)
          <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">abs_float</span> <span class="">e</span> -. <span class="">e_l</span>) <span class="keyword ">then</span> <span class="constructor">D1</span>
  | <span class="constructor">D1</span> -&gt; <span class="keyword ">do</span> <span class="">d</span> = <span class="">d1</span> <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">e_l</span> -. <span class="">abs_float</span> <span class="">e</span>) <span class="keyword ">then</span> <span class="constructor">D2</span>

<span class="comment">(* The process:

      G(s) =       K * alpha
              -------------------
              s(s + 1)(s + alpha)

   <span class="string">"The nominal values of the parameters are K = 3, ..., and alpha = 20."</span>

   The state-space realization can be calculated in Matlab:
     sys1 = tf(60, [1 21 20 0])
     [a, b, c, d] = ss()

   <span class="string">"The process gain is suddenly increaed by a factor of 5 at t = 25."</span>
     sys2 = 5 * sys1
     [a, b, c, d] = ss(sys2)

   And similarly in Scilab:
     s=%s
     sys1 = 60 / (s * (s + 1) * (s + 20))
     [a, b, c, d] = abcd(sys1)

     sys2 = 5 * sys1
     [a, b, c, d] = abcd(sys2)
*)</span>
<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">process</span> <span class="">u</span> = <span class="">y</span> <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">automaton</span>
      | <span class="constructor">G5</span>  -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">4.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">3.750</span> <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">25.0</span>)) <span class="keyword ">then</span> <span class="constructor">G15</span>
      | <span class="constructor">G15</span> -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">8.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">9.375</span> <span class="keyword ">done</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">siso_3o</span> ((-<span class="number">21.0</span>, -<span class="number">5.0</span>, <span class="number">0.0</span>,
                      <span class="number">4.0</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,
                      <span class="number">0.0</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>),
                   (<span class="">b1</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), (<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="">c3</span>), <span class="number">0.0</span>, <span class="">u</span>)

<span class="keyword keyword module ">open</span> <span class="constructor">Scope</span> <span class="comment">(* Dump *)</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">plot</span> (<span class="">title</span>, <span class="">y</span>, <span class="">y_m</span>, <span class="">u</span>, <span class="">e</span>) = () <span class="keyword ">where</span>
  _ = <span class="keyword ">present</span> (<span class="keyword expr ">period</span> (<span class="number">0.08</span>)) -&gt; (
    <span class="keyword ">let</span>
    <span class="keyword ">rec</span> <span class="">s1</span> = <span class="">scope2</span> (-<span class="number">1.5</span>, <span class="number">1.5</span>, (<span class="string">"y_m"</span>, <span class="">linear</span>, <span class="">y_m</span>),
                                (<span class="string">"y"</span>,   <span class="">linear</span>, <span class="">y</span>))
    <span class="keyword ">and</span> <span class="">s2</span> = <span class="">scope</span> (-<span class="number">1.0</span>, <span class="number">1.0</span>, (<span class="string">"u"</span>, <span class="">square</span>, <span class="">u</span>))
    <span class="keyword ">and</span> <span class="">s3</span> = <span class="">scope</span> (-<span class="number">1.0</span>, <span class="number">1.3</span>, (<span class="string">"e"</span>, <span class="">linear</span>, <span class="">e</span>))
    <span class="keyword ">and</span> <span class="">t</span> = <span class="number">0.0</span> <span class="keyword expr ">fby</span> <span class="">t</span> <span class="operator">+.</span> <span class="number">0.08</span>
    <span class="keyword ">in</span> <span class="">window3</span> (<span class="">title</span>, <span class="number">50.0</span>, <span class="">t</span>, <span class="">s1</span>, <span class="">s2</span>, <span class="">s3</span>))

</code></pre></div></div></div></div>

<p>The models are tested over a period of 50s in response to a <strong>command
signal</strong> which starts at <code>1</code> initially, drops to <code>0</code> at <code>17.5</code> seconds, and
then rises to <code>1</code> again at <code>35</code> seconds.
The command signal is defined using a hybrid automaton in a node called
<code>command</code>.</p>

<p><img src="img/soas-command.png" alt="Command input" title="Command input" id="commandinput" /></p>

<p>The <strong>process</strong> to be controlled is described by the transfer function:</p>

<p><img src="img/soas-process.png" alt="Process transfer function" title="Process transfer function" id="processtransferfunction" /></p>

<p>where, initially, K = 3 and α = 20, but where the <em>process gain is suddenly
increased by a factor of 5 at t = 25</em>.
The state-space realizations of these two systems are readily calculated in
either <a href="http://www.mathworks.com/products/matlab/">Matlab</a>:</p>

<pre><code>sys1 = tf(60, [1 21 20 0])
[a, b, c, d] = ss()

sys2 = 5 * sys1
[a, b, c, d] = ss(sys2)
</code></pre>

<p>or <a href="https://www.scilab.org/">Scilab</a>:</p>

<pre><code>s=
sys1 = 60 / (s * (s + 1) * (s + 20))
[a, b, c, d] = abcd(sys1)

sys2 = 5 * sys1
[a, b, c, d] = abcd(sys2)
</code></pre>

<p>We implement them in a node called <code>process</code> using a hybrid automaton and a
generic <code>siso_3o</code> node that takes the state-space matrices as tupled
arguments.</p>

<h3 id="basicsoas">Basic SOAS</h3>

<p>The first model comprises a simple feedback loop—relay, process, and
inverter—that tries to follow the reponse of a reference model to the
command signal.
Other elements will be added successively.</p>

<p><img src="img/soas-model1.png" alt="Basic SOAS: model" title="Basic SOAS: model" id="basicsoas:model" /></p>

<div id="soas_relaycontrol-soas1_basic-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#soas_relaycontrol-soas1_basic-box"
   href="#soas_relaycontrol-soas1_basic"><i class="icon-file"></i> soas1_basic.zls</a>
</div>

<div id="soas_relaycontrol-soas1_basic" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
    Example 10.2 (A basic SOAS)
    from <span class="string">"Adaptive Control"</span>, 2e, Åström and Wittenmark, 2008
 *)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Soas</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = () <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">i</span> = <span class="">command</span> ()
  <span class="keyword ">and</span> <span class="">y_m</span> = <span class="">reference</span> <span class="">i</span>
  <span class="keyword ">and</span> <span class="">u</span> = <span class="">relay</span> (<span class="number">0.35</span>, <span class="">e</span>)
  <span class="keyword ">and</span> <span class="">e</span> =  <span class="">y_m</span> -. <span class="">y</span>

  <span class="comment">(* Rmk: we should be able to put the automaton below *)</span>
  <span class="comment">(* into a function. We can not for the moment as there *)</span>
  <span class="comment">(* is no inlining of function call a priori *)</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">G3</span>  -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">4.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">3.750</span> <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">25.0</span>)) <span class="keyword ">then</span> <span class="constructor">G15</span>
      | <span class="constructor">G15</span> -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">8.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">9.375</span> <span class="keyword ">done</span>

  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x1</span> = -<span class="number">21.0</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  -<span class="number">5.0</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">b1</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> =   <span class="number">4.0</span> <span class="operator">*.</span> <span class="">x1</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x3</span> =   <span class="number">1.0</span> <span class="operator">*.</span> <span class="">x2</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c3</span> <span class="operator">*.</span> <span class="">x3</span>

  <span class="keyword ">and</span> () = <span class="">plot</span> (<span class="string">"Basic SOAS"</span>, <span class="">y</span>, <span class="">y_m</span>, <span class="">u</span>, <span class="">e</span>)

</code></pre></div></div></div></div>

<p>The <strong>reference model</strong> is described as a second order system with damping
coefficient ζ = 0.7 and natural frequency ω_n = 1 rad/sec.
Its state-space realization is readily calculated in either
<a href="http://www.mathworks.com/products/matlab/">Matlab</a>:</p>

<pre><code>[A, B, C, D] = ord2(1.0, 0.7)</code></pre>

<p>or <a href="https://www.scilab.org/">Scilab</a>:</p>

<pre><code>s = ; wn = 1.0; zeta = 0.7;
tf2ss(syslin('c', wn^2, s^2 + 2*zeta*wn*s + wn^2))</code></pre>

<p>We express it in a node called <code>reference</code> using a generic <code>siso_2o</code> node.</p>

<p>The response of the reference model to the command input is shown in red
below.
The actual output of the feedback loop is shown in blue.</p>

<p><img src="img/soas-output1.png" alt="Basic SOAS: output" title="Basic SOAS: output" id="basicsoas:output" /></p>

<p>The <strong>relay</strong> is modelled in a node called <code>relay</code> using a hybrid
automaton that alternates between <code>High</code> (output = <code>d</code>) and <code>Low</code> (output =
<code>-d</code>) states in response to zero-crossings on its input signal.
The relay's value is shown below.</p>

<p><img src="img/soas-relay1.png" alt="Basic SOAS: relay" title="Basic SOAS: relay" id="basicsoas:relay" /></p>

<h3 id="soaswithleadnetwork">SOAS with lead network</h3>

<p>The next model augments the basic model with a compensation network that
adds a phase lead of -π.</p>

<p><img src="img/soas-model2.png" alt="SOAS with lead network" title="SOAS with lead network" id="soaswithleadnetwork" /></p>

<div id="soas_relaycontrol-soas2_leadnet-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#soas_relaycontrol-soas2_leadnet-box"
   href="#soas_relaycontrol-soas2_leadnet"><i class="icon-file"></i> soas2_leadnet.zls</a>
</div>

<div id="soas_relaycontrol-soas2_leadnet" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
    Example 10.2 (A basic SOAS)
    from <span class="string">"Adaptive Control"</span>, 2e, Åström and Wittenmark, 2008
 *)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Soas</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = () <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">i</span> = <span class="">command</span> ()
  <span class="keyword ">and</span> <span class="">y_m</span> = <span class="">reference</span> <span class="">i</span>
  <span class="keyword ">and</span> <span class="">u</span> = <span class="">relay</span> (<span class="number">0.35</span>, <span class="">g_f</span> <span class="">e</span>)
  <span class="keyword ">and</span> <span class="">e</span> =  <span class="">y_m</span> -. <span class="">y</span>

  <span class="comment">(* Rmk: we should be able to put the automaton below *)</span>
  <span class="comment">(* into a function. We can not for the moment as there *)</span>
  <span class="comment">(* is no inlining of function call a priori *)</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">G3</span>  -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">4.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">3.750</span> <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">25.0</span>)) <span class="keyword ">then</span> <span class="constructor">G15</span>
      | <span class="constructor">G15</span> -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">8.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">9.375</span> <span class="keyword ">done</span>

  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x1</span> = -<span class="number">21.0</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  -<span class="number">5.0</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">b1</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> =   <span class="number">4.0</span> <span class="operator">*.</span> <span class="">x1</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x3</span> =   <span class="number">1.0</span> <span class="operator">*.</span> <span class="">x2</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c3</span> <span class="operator">*.</span> <span class="">x3</span>

  <span class="keyword ">and</span> () = <span class="">plot</span> (<span class="string">"SOAS with lead network"</span>, <span class="">y</span>, <span class="">y_m</span>, <span class="">u</span>, <span class="">e</span>)

</code></pre></div></div></div></div>

<p>The compensation filter is defined as a transfer function:</p>

<p><img src="img/soas-filter.png" alt="G_f(s) = 1.2(s + 5)/(s + 15)" title="Filter" id="g_fs1.2s5s15" /></p>

<p>which is implemented in the node <code>g_f</code> using the generic node <code>siso_1o</code>
after having calculated its state-space realization in either
<a href="http://www.mathworks.com/products/matlab/">Matlab</a>:</p>

<pre><code>[a, b, c, d] = ss(1.2 * tf([1 5], [1 15]))</code></pre>

<p>or <a href="https://www.scilab.org/">Scilab</a>:</p>

<pre><code>s = poly(0, 's')
[a, b, c, d] = abcd(tf2ss(1.2 * (s + 5) / (s + 15)))</code></pre>

<p>The compensation filter decreases the amplitude of oscillation while
maintaining the reponse speed, as can be seen in the simulation results
below.</p>

<p><img src="img/soas-output2.png" alt="SOAS with lead network: output" title="SOAS with lead network: output" id="soaswithleadnetwork:output" /></p>

<h3 id="soaswithleadnetworkandgainchanger">SOAS with lead network and gain changer</h3>

<p>A gain changer is added in the final model.
It uses so called <em>up logic</em> to speed up the controller's reponse.</p>

<p><img src="img/soas-model3.png" alt="SOAS with lead network and gain changer: model" title="SOAS with lead network and gain changer: model" id="soaswithleadnetworkandgainchanger:model" /></p>

<div id="soas_relaycontrol-soas3_gainchanger-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#soas_relaycontrol-soas3_gainchanger-box"
   href="#soas_relaycontrol-soas3_gainchanger"><i class="icon-file"></i> soas3_gainchanger.zls</a>
</div>

<div id="soas_relaycontrol-soas3_gainchanger" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
    Example 10.2 (A basic SOAS)
    from <span class="string">"Adaptive Control"</span>, 2e, Åström and Wittenmark, 2008
 *)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Soas</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = () <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">i</span> = <span class="">command</span> ()
  <span class="keyword ">and</span> <span class="">y_m</span> = <span class="">reference</span> <span class="">i</span>
  <span class="keyword ">and</span> <span class="">u</span> = <span class="">relay</span> (<span class="">gain_changer</span> (<span class="number">0.5</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="">e</span>), <span class="">g_f</span> <span class="">e</span>)
  <span class="keyword ">and</span> <span class="">e</span> =  <span class="">y_m</span> -. <span class="">y</span>

  <span class="comment">(* Rmk: we should be able to put the automaton below *)</span>
  <span class="comment">(* into a function. We can not for the moment as there *)</span>
  <span class="comment">(* is no inlining of function call a priori *)</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">G3</span>  -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">4.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">3.750</span> <span class="keyword ">until</span> (<span class="keyword expr ">period</span> (<span class="number">25.0</span>)) <span class="keyword ">then</span> <span class="constructor">G15</span>
      | <span class="constructor">G15</span> -&gt; <span class="keyword ">do</span> <span class="">b1</span> = <span class="number">8.0</span> <span class="keyword ">and</span> <span class="">c3</span> = <span class="number">9.375</span> <span class="keyword ">done</span>

  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x1</span> = -<span class="number">21.0</span> <span class="operator">*.</span> <span class="">x1</span>  <span class="operator">+.</span>  -<span class="number">5.0</span> <span class="operator">*.</span> <span class="">x2</span>  <span class="operator">+.</span>  <span class="">b1</span> <span class="operator">*.</span> <span class="">u</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> =   <span class="number">4.0</span> <span class="operator">*.</span> <span class="">x1</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x3</span> =   <span class="number">1.0</span> <span class="operator">*.</span> <span class="">x2</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">y</span> = <span class="">c3</span> <span class="operator">*.</span> <span class="">x3</span>

  <span class="keyword ">and</span> () = <span class="">plot</span> (<span class="string">"SOAS with lead network and gain changer"</span>, <span class="">y</span>, <span class="">y_m</span>, <span class="">u</span>, <span class="">e</span>)

</code></pre></div></div></div></div>

<p>A gain changer increases the relay's amplitude (<code>d</code>) when a specified
tolerance (e_l) is exceeded.</p>

<p><img src="img/soas-gainchanger.png" alt="d = if |e| > e_l then d_1 else d_2 + (d_1 - d_2)e^(-(t - t_0)/T)" title="Gain changer" id="difee_lthend_1elsed_2d_1-d_2e-t-t_0t" /></p>

<p>This logic is readily implemented in the <code>gain_changer</code> node using a hybrid
automaton.</p>

<p>The simulation results show that the new controller responds with smaller
amplitude oscillations to the system with higher gain, without losing
performance for the system with smaller gain.</p>

<p><img src="img/soas-output3.png" alt="SOAS with lead network and gain changer: output" title="SOAS with lead network and gain changer: output" id="soaswithleadnetworkandgainchanger:output" /></p>

<p>The effect of the gain changing logic on the relay output is evident in the
exponential envelopes on the signal shown below.</p>

<p><img src="img/soas-relay3.png" alt="SOAS with lead network and gain changer: relay" title="SOAS with lead network and gain changer: relay" id="soaswithleadnetworkandgainchanger:relay" /></p>
</div><hr />
<div id="stickysprings" class="example-section">
<h2 id="stickymasses">Sticky Masses</h2>

<div class="requirements">
<p class="text-info">
<i class="icon-info-sign"></i> <em>Requires</em>:
Lablgtk2 (glMLite)</p>
</p>
</div>

<p>This example is based on example 6.8 in Edward A. Lee and Pravin Varaiya,
<a href="http://leevaraiya.org/"><em>Structure and Interpretation of Signals and
Systems</em></a>, Second Edition,
and the Ptolemy II model by Jie Liu, Haiyang Zheng,
and Edward A. Lee.</p>

<p><img src="img/stickysprings.png" alt="Sticky masses model" title="Sticky masses model" id="stickymassesmodel" /></p>

<p>The model comprises two sticky round masses, each on the end of a spring.
The other ends of the springs are tied to opposing walls. After the springs
are compressed (or extended) and released the masses oscillate back and
forth, and may collide. After a collision, the masses remain stuck together
until the pulling forces from the springs are greater than a <em>stickiness</em>
value (which decreases exponentially after a collision).</p>

<div id="stickysprings-stickysprings-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#stickysprings-stickysprings-box"
   href="#stickysprings-stickysprings"><i class="icon-file"></i> stickysprings.zls</a>
</div>

<div id="stickysprings-stickysprings" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(* ** Parameters ** *)</span>

<span class="comment">(* neutral positions of the two masses *)</span>
<span class="keyword ">let</span> <span class="">p1</span> = <span class="number">1.25</span>
<span class="keyword ">let</span> <span class="">p2</span> = <span class="number">1.75</span>

<span class="comment">(* initial positions of the two masses: y1_i < y2_i *)</span>
<span class="keyword ">let</span> <span class="">x1_i</span> = <span class="number">0.0</span>
<span class="keyword ">let</span> <span class="">x2_i</span> = <span class="number">3.0</span>

<span class="comment">(* spring constants *)</span>
<span class="comment">(* let k1 = 4.0 <span class="comment">(* exhibits problem *)</span> *)</span>
<span class="keyword ">let</span> <span class="">k1</span> = <span class="number">1.0</span>
<span class="keyword ">let</span> <span class="">k2</span> = <span class="number">2.5</span> <span class="comment">(* 2.0 *)</span>

<span class="comment">(* masses *)</span>
<span class="keyword ">let</span> <span class="">m1</span> = <span class="number">1.5</span>
<span class="keyword ">let</span> <span class="">m2</span> = <span class="number">1.0</span>

<span class="comment">(* stickyness *)</span>
<span class="keyword ">let</span> <span class="">stickiness_max</span> = <span class="number">10.0</span>
<span class="keyword ">let</span> <span class="">tau</span> = <span class="number">0.5</span>

<span class="comment">(* ** Model ** *)</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">sticky</span> () =
  ((<span class="">x1</span>, <span class="">v1</span>), (<span class="">x2</span>, <span class="">v2</span>), <span class="">pull</span>, <span class="">stickiness_out</span>, <span class="">total</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">x1</span> = <span class="">v1</span> <span class="keyword ">init</span> <span class="">x1_i</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x2</span> = <span class="">v2</span> <span class="keyword ">init</span> <span class="">x2_i</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">v1</span> = <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">v2</span> = <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="">total</span> = <span class="number">0.5</span> <span class="operator">*.</span> <span class="">m1</span> <span class="operator">*.</span> <span class="">v1</span> <span class="operator">*.</span> <span class="">v1</span> <span class="operator">+.</span> <span class="number">0.5</span> <span class="operator">*.</span> <span class="">m2</span> <span class="operator">*.</span> <span class="">v2</span> <span class="operator">*.</span> <span class="">v2</span> <span class="operator">+.</span>
              <span class="number">0.5</span> <span class="operator">*.</span> <span class="">k1</span> <span class="operator">*.</span> (<span class="">x1</span> -. <span class="">p1</span>) <span class="operator">*.</span> (<span class="">x1</span> -. <span class="">p1</span>) <span class="operator">+.</span>
              <span class="number">0.5</span> <span class="operator">*.</span> <span class="">k2</span> <span class="operator">*.</span> (<span class="">x2</span> -. <span class="">p2</span>) <span class="operator">*.</span> (<span class="">x2</span> -. <span class="">p2</span>) 
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">Apart</span> -&gt;
          <span class="keyword ">local</span> <span class="">mediant</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span>  <span class="keyword ">der</span> <span class="">v1</span> = <span class="">k1</span> <span class="operator">*.</span> (<span class="">p1</span> -. <span class="">x1</span>) <span class="operator">/.</span> <span class="">m1</span>
          <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">v2</span> = <span class="">k2</span> <span class="operator">*.</span> (<span class="">p2</span> -. <span class="">x2</span>) <span class="operator">/.</span> <span class="">m2</span>
          <span class="keyword ">and</span> <span class="">mediant</span> = (<span class="">v1</span> <span class="operator">*.</span> <span class="">m1</span> <span class="operator">+.</span> <span class="">v2</span> <span class="operator">*.</span> <span class="">m2</span>) <span class="operator">/.</span> (<span class="">m1</span> <span class="operator">+.</span> <span class="">m2</span>)
          <span class="keyword ">and</span> <span class="">pull</span> = <span class="number">0.0</span>
          <span class="keyword ">and</span> <span class="">stickiness_out</span> = <span class="number">0.0</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span> (<span class="">x1</span> -. <span class="">x2</span>) <span class="keyword ">then</span> 
             <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">v1</span> = <span class="">mediant</span>
             <span class="keyword ">and</span> <span class="keyword ">next</span> <span class="">v2</span> = <span class="">mediant</span> <span class="keyword ">in</span> <span class="constructor">Together</span>
      | <span class="constructor">Together</span> -&gt;
          <span class="keyword ">local</span> <span class="">y_dot_dot</span>, <span class="">stickiness</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span>  <span class="">pull</span> = 
               <span class="">abs_float</span> (-. <span class="keyword expr ">last</span> <span class="">x1</span> <span class="operator">*.</span> (<span class="">k1</span> <span class="operator">+.</span> <span class="">k2</span>) <span class="operator">+.</span> (<span class="">k2</span> <span class="operator">*.</span> <span class="">p2</span> -. <span class="">k1</span> <span class="operator">*.</span> <span class="">p1</span>))
          <span class="keyword ">and</span> <span class="">y_dot_dot</span> = 
               (<span class="">k1</span> <span class="operator">*.</span> <span class="">p1</span> <span class="operator">+.</span> <span class="">k2</span>  <span class="operator">*.</span> <span class="">p2</span> -. (<span class="">k1</span> <span class="operator">+.</span> <span class="">k2</span>) <span class="operator">*.</span> <span class="keyword expr ">last</span> <span class="">x1</span>) <span class="operator">/.</span> (<span class="">m1</span> <span class="operator">+.</span> <span class="">m2</span>)
          <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">v1</span> = <span class="">y_dot_dot</span>
          <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">v2</span> = <span class="">y_dot_dot</span>
          <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">stickiness</span> = -. <span class="">stickiness</span> <span class="operator">/.</span> <span class="">tau</span> <span class="keyword ">init</span> <span class="">stickiness_max</span>
          <span class="keyword ">and</span> <span class="">stickiness_out</span> = <span class="">stickiness</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span> (<span class="">pull</span> -. <span class="">stickiness</span>) <span class="keyword ">then</span> <span class="constructor">Apart</span>

<span class="comment">(* ** plotting ** *)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Scope</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">plot</span> (<span class="">t</span>, (<span class="">y1</span>, <span class="">y1_dot</span>), (<span class="">y2</span>, <span class="">y2_dot</span>), <span class="">pull_force</span>, <span class="">stickiness</span>, <span class="">total</span>) =
  <span class="keyword ">let</span> <span class="">s1</span> = <span class="">scope2</span> (<span class="number">0.0</span>, <span class="number">3.0</span>, (<span class="string">"p1"</span>, <span class="">linear</span>, <span class="">y1</span>), (<span class="string">"p2"</span>, <span class="">linear</span>, <span class="">y2</span>)) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">s2</span> = <span class="">scope2</span> (-<span class="number">1.5</span>, <span class="number">1.5</span>, (<span class="string">"v1"</span>, <span class="">linear</span>, <span class="">y1_dot</span>), (<span class="string">"v2"</span>, <span class="">linear</span>, <span class="">y2_dot</span>)) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">s3</span> = <span class="">scope2</span> (<span class="number">0.0</span>, <span class="">stickiness_max</span>, (<span class="string">"Pulling force"</span>, <span class="">linear</span>, <span class="">pull_force</span>),
                                        (<span class="string">"Stickiness"</span>, <span class="">linear</span>, <span class="">stickiness</span>)) <span class="keyword ">in</span>
  <span class="keyword ">let</span> <span class="">s4</span> = <span class="">scope</span> (<span class="number">0.0</span>, <span class="number">3.0</span>, (<span class="string">"Total Energy"</span>, <span class="">linear</span>, <span class="">total</span>)) <span class="keyword ">in</span>
  <span class="">window4</span> (<span class="string">"sticky springs"</span>, <span class="number">30.0</span>, <span class="">t</span>, <span class="">s1</span>, <span class="">s2</span>, <span class="">s3</span>, <span class="">s4</span>)

<span class="comment">(* ** main ** *)</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = 
  <span class="keyword ">let</span> <span class="keyword ">der</span> <span class="">t</span> = <span class="number">1.0</span> <span class="keyword ">init</span> <span class="number">0.0</span> <span class="keyword ">in</span>
  <span class="keyword ">let</span> ((<span class="">y1</span>, <span class="">y1_dot</span>), (<span class="">y2</span>, <span class="">y2_dot</span>), <span class="">pull_force</span>, <span class="">stickiness</span>, <span class="">total</span>) = <span class="">sticky</span> () <span class="keyword ">in</span>
  <span class="keyword ">present</span>
     (<span class="keyword expr ">period</span> (<span class="number">0.10</span>)) -&gt;
       <span class="">plot</span> (<span class="">t</span>, (<span class="">y1</span>, <span class="">y1_dot</span>), (<span class="">y2</span>, <span class="">y2_dot</span>), <span class="">pull_force</span>, <span class="">stickiness</span>, <span class="">total</span>);
  ()
</code></pre></div></div></div></div>
</div><hr />
<div id="backhoe" class="example-section">
<h2 id="backhoe">Backhoe</h2>

<div class="requirements">
<p class="text-info">
<i class="icon-info-sign"></i> <em>Requires</em>:
Lablgtk2</p>
</p>
</div>

<p>The Backhoe loader is an <a href="http://www.tbrk.org/esterel/backhoe.html">original
example</a> that we developed to
teach reactive programming.</p>

<p><img src="img/backhoeloop.png" alt="Backhoe control loop" title="Backhoe loop" id="backhoecontrolloop" /></p>

<p>The model comprises two interconnected elements:</p>

<ul>
<li>a continuous model of the plant (parts of the backhoe)</li>
<li>a discrete controller</li>
</ul>

<p>The original programming challenge focused on the discrete controller, but
expressing the continuous dynamics is also an interesting programming
problem, as is interfacing the two models.</p>

<p><img src="img/backhoesensors.png" alt="Backhoe model: sensor names and locations" title="Backhoe sensor names" id="backhoemodel:sensornamesandlocations" /></p>

<p>The discrete controller receives input from sensors which are defined inside
the continuous model. There are sensors for each of three buttons
(<code>stop_button</code>, <code>extend_button</code>, and <code>retract_button</code>), for indicating
whether the legs are fully retracted (<code>legs_in</code>) or fully extended
(<code>legs_out</code>), and for indicating whether each of the rear segments is fully
retracted (<code>*_in</code>) or fully extended (<code>*_out</code>).</p>

<p><img src="img/backhoeactuators.png" alt="Backhoe model: actuator names" title="Backhoe actuator names" id="backhoemodel:actuatornames" /></p>

<p>There are control signals for three lamps (<code>alarm_lamp</code>, <code>done_lamp</code>, and
<code>cancel_lamp</code>) and for triggering leg extension (<code>legs_extend</code>), leg
retraction (<code>legs_retract</code>), and stopping leg motion (<code>legs_step</code>). There
are three control signals pel segment: setting an internal valve for pushing
(<code>*_push</code>), or for pulling (<code>*_pull</code>), and for driving hydraulic fluid
through the valve (<code>*_drive</code>). It is assumed that a lower-level controller
maintains a segments position when it is not being driven.</p>

<p><img src="img/backhoesegmentauto.png" alt="Backhoe segment model" title="Backhoe segment model" id="backhoesegmentmodel" /></p>

<p>Each segment is modelled using set of equations that include a hybrid
automaton. Two types of dynamics are modelled: moving and stopping with
momentum (modelled as a Proportional-Integral controller) and bouncing at
the limits of movement (modelled as instantaneous reset).</p>

<div id="backhoe-backhoecontrol-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#backhoe-backhoecontrol-box"
   href="#backhoe-backhoecontrol"><i class="icon-file"></i> backhoecontrol.zls</a>
</div>

<div id="backhoe-backhoecontrol" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">after</span> (<span class="">n</span>, <span class="">t</span>) = (<span class="">c</span> = <span class="">n</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">c</span> = <span class="number">0</span> <span class="keyword expr ">fby</span> <span class="">min</span> ((<span class="keyword ">if</span> <span class="">t</span> <span class="keyword ">then</span> <span class="">c</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword ">else</span> <span class="">c</span>), <span class="">n</span>)

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">blink</span> (<span class="">n</span>, <span class="">t</span>) = <span class="">x</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">On</span>  -&gt; <span class="keyword ">do</span> <span class="">x</span> = <span class="keyword constant ">true</span>  <span class="keyword ">until</span> (<span class="">after</span> (<span class="">n</span>, <span class="">t</span>)) <span class="keyword ">then</span> <span class="constructor">Off</span>
  | <span class="constructor">Off</span> -&gt; <span class="keyword ">do</span> <span class="">x</span> = <span class="keyword constant ">false</span> <span class="keyword ">until</span> (<span class="">after</span> (<span class="">n</span>, <span class="">t</span>)) <span class="keyword ">then</span> <span class="constructor">On</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">blink2</span>(<span class="">ton</span>, <span class="">toff</span>, <span class="">t</span>) = <span class="">x</span> <span class="keyword ">where</span>
  <span class="keyword ">automaton</span>
  | <span class="constructor">On</span>  -&gt; <span class="keyword ">do</span> <span class="">x</span> = <span class="keyword constant ">true</span>  <span class="keyword ">until</span> (<span class="">after</span> (<span class="">ton</span>, <span class="">t</span>)) <span class="keyword ">then</span> <span class="constructor">Off</span>
  | <span class="constructor">Off</span> -&gt; <span class="keyword ">do</span> <span class="">x</span> = <span class="keyword constant ">false</span> <span class="keyword ">until</span> (<span class="">after</span> (<span class="">toff</span>, <span class="">t</span>)) <span class="keyword ">then</span> <span class="constructor">On</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">leg_controller</span> 
    ((<span class="">legs_in</span>, <span class="">legs_out</span>), (<span class="">stop_button</span>, <span class="">retract_button</span>, <span class="">extend_button</span>), <span class="">second</span>) = 
    ((<span class="">legs_extend</span>, <span class="">legs_retract</span>, <span class="">legs_stop</span>), <span class="">alarm</span>, <span class="">extended</span>)
  <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">alarm</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">extended</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">LegsIn</span> -&gt;
          <span class="keyword ">do</span> <span class="">alarm</span> = <span class="keyword constant ">false</span>
          <span class="keyword ">until</span> <span class="">extend_button</span> <span class="keyword ">then</span> <span class="constructor">LegsMoving</span>(<span class="keyword constant ">true</span>)

      | <span class="constructor">LegsMoving</span>(<span class="">extend</span>) -&gt;
          <span class="keyword ">local</span> <span class="">at_extremity</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span> <span class="keyword ">init</span> <span class="">at_extremity</span> = <span class="keyword constant ">false</span>
          <span class="keyword ">and</span>
          <span class="keyword ">automaton</span>
             | <span class="constructor">Initial</span> -&gt;
                 <span class="keyword ">do</span>
                 <span class="keyword ">unless</span> <span class="">extend</span>       <span class="keyword ">then</span> <span class="constructor">Extending</span>
                   <span class="keyword ">else</span> (<span class="">not</span> <span class="">extend</span>) <span class="keyword ">then</span> <span class="constructor">Retracting</span>

             | <span class="constructor">Extending</span> -&gt;
                 <span class="keyword ">do</span>
                   <span class="keyword ">emit</span> <span class="">legs_extend</span>
                 <span class="keyword ">until</span> <span class="">stop_button</span>    <span class="keyword ">then</span> <span class="constructor">Stopped</span>
                  <span class="keyword ">else</span> <span class="">retract_button</span> <span class="keyword ">then</span> <span class="constructor">Retracting</span>
                  <span class="keyword ">else</span> <span class="">legs_out</span>       <span class="keyword ">then</span> <span class="constructor">Done</span>

             | <span class="constructor">Retracting</span> -&gt;
                 <span class="keyword ">do</span>
                   <span class="keyword ">emit</span> <span class="">legs_retract</span>
                 <span class="keyword ">until</span> <span class="">stop_button</span>   <span class="keyword ">then</span> <span class="constructor">Stopped</span>
                  <span class="keyword ">else</span> <span class="">extend_button</span> <span class="keyword ">then</span> <span class="constructor">Extending</span>
                  <span class="keyword ">else</span> <span class="">legs_in</span>       <span class="keyword ">then</span> <span class="constructor">Done</span>

             | <span class="constructor">Stopped</span> -&gt;
                 <span class="keyword ">do</span>
                   <span class="keyword ">emit</span> <span class="">legs_stop</span>
                 <span class="keyword ">until</span> <span class="">extend_button</span>  <span class="keyword ">then</span> <span class="constructor">Extending</span>
                  <span class="keyword ">else</span> <span class="">retract_button</span> <span class="keyword ">then</span> <span class="constructor">Retracting</span>

              | <span class="constructor">Done</span> -&gt; <span class="keyword ">do</span> <span class="">at_extremity</span> = <span class="keyword constant ">true</span> <span class="keyword ">done</span>

             <span class="keyword ">and</span> <span class="">alarm</span> = <span class="keyword constant ">false</span> -&gt; <span class="">not</span> (<span class="keyword expr ">pre</span> <span class="">alarm</span>)
             <span class="keyword ">and</span> <span class="">extended</span> = <span class="keyword constant ">false</span>

          <span class="keyword ">until</span> (<span class="">at_extremity</span> <span class="operator">&&</span> <span class="">legs_out</span>) <span class="keyword ">then</span> <span class="constructor">LegsOut</span>
           <span class="keyword ">else</span> (<span class="">at_extremity</span> <span class="operator">&&</span> <span class="">legs_in</span>)  <span class="keyword ">then</span> <span class="constructor">LegsIn</span>
           <span class="keyword ">else</span> (<span class="">after</span>(<span class="number">20</span>, <span class="">second</span>))        <span class="keyword ">then</span> <span class="constructor">Error</span>

      | <span class="constructor">LegsOut</span> -&gt;
          <span class="keyword ">do</span>
            <span class="">extended</span> = <span class="keyword constant ">true</span> <span class="keyword ">and</span> <span class="">alarm</span> = <span class="keyword constant ">false</span>
          <span class="keyword ">unless</span> <span class="">retract_button</span> <span class="keyword ">then</span> <span class="constructor">LegsMoving</span>(<span class="keyword constant ">false</span>)

      | <span class="constructor">Error</span> -&gt;
          <span class="keyword ">do</span>
                <span class="">alarm</span> = <span class="keyword constant ">true</span>
            <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">legs_retract</span>
          <span class="keyword ">until</span> <span class="">legs_in</span> <span class="keyword ">then</span> <span class="constructor">LegsIn</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">sampled_controller</span>
  ((<span class="">leg_sensors</span>, (<span class="">boom_in</span>, <span class="">boom_out</span>), (<span class="">stick_in</span>, <span class="">stick_out</span>), (<span class="">bucket_in</span>, <span class="">bucket_out</span>)),
   (<span class="">stop_button</span>, <span class="">retract_button</span>, <span class="">extend_button</span>), <span class="">second</span>)
  =  ((<span class="">boom_push</span>,   <span class="">boom_pull</span>,   <span class="">boom_drive</span>),
      (<span class="">stick_push</span>,  <span class="">stick_pull</span>,  <span class="">stick_drive</span>),
      (<span class="">bucket_push</span>, <span class="">bucket_pull</span>, <span class="">bucket_drive</span>),
      (<span class="">legs_extend</span>, <span class="">legs_retract</span>, <span class="">legs_stop</span>),
      (<span class="">alarm_lamp</span>, <span class="">done_lamp</span>, <span class="">cancel_lamp</span>))
  <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">boom_drive</span>   = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">stick_drive</span>  = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">bucket_drive</span> = <span class="keyword constant ">false</span>

  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">alarm_lamp</span>  = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">done_lamp</span>   = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">cancel_lamp</span> = <span class="keyword constant ">false</span>

  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">legs_extended</span> = <span class="keyword constant ">false</span>

  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">Legs</span> -&gt;
          <span class="keyword ">do</span> <span class="">alarm_lamp</span>  = <span class="">leg_alarm</span>
          <span class="keyword ">and</span> <span class="">done_lamp</span>   = <span class="keyword constant ">false</span>
          <span class="keyword ">and</span> ((<span class="">legs_extend</span>, <span class="">legs_retract</span>, <span class="">legs_stop</span>), <span class="">leg_alarm</span>, <span class="">legs_extended</span>)
                  = <span class="">leg_controller</span> (<span class="">leg_sensors</span>, (<span class="">stop_button</span>, <span class="">retract_button</span>, <span class="">extend_button</span>), <span class="">second</span>)
          <span class="keyword ">until</span> (<span class="">legs_extended</span>) <span class="keyword ">then</span> <span class="constructor">Stable</span>

      | <span class="constructor">Stable</span> -&gt;
          <span class="keyword ">do</span> <span class="">alarm_lamp</span>  = <span class="keyword constant ">false</span>
          <span class="keyword ">and</span> <span class="">done_lamp</span>   = <span class="keyword constant ">true</span>
          <span class="keyword ">and</span> <span class="">cancel_lamp</span> = <span class="keyword constant ">false</span>
          <span class="keyword ">until</span>  <span class="">extend_button</span>  <span class="keyword ">then</span> <span class="constructor">Dig</span>
          <span class="keyword ">unless</span> <span class="">retract_button</span> <span class="keyword ">continue</span> <span class="constructor">Legs</span>

      | <span class="constructor">Dig</span> -&gt;
          <span class="keyword ">local</span> <span class="">finished</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span> <span class="keyword ">init</span> <span class="">finished</span> = <span class="keyword constant ">false</span>
          <span class="keyword ">and</span>
          <span class="keyword ">automaton</span>
            | <span class="constructor">Move</span> -&gt;
                <span class="keyword ">do</span> <span class="">done_lamp</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">and</span> <span class="">alarm_lamp</span> = <span class="">blink</span>(<span class="number">2</span>, <span class="">second</span>)
                <span class="keyword ">and</span>
                <span class="keyword ">automaton</span>
                  | <span class="constructor">RaiseStickBucket</span> -&gt;
                      <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">stick_pull</span>  <span class="keyword ">and</span> <span class="">stick_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">bucket_pull</span> <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">unless</span> (<span class="">stick_in</span> <span class="operator">&&</span> <span class="">bucket_in</span>) <span class="keyword ">then</span> <span class="constructor">LowerBoom</span>

                  | <span class="constructor">LowerBoom</span> -&gt;
                      <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">boom_push</span> <span class="keyword ">and</span> <span class="">boom_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">false</span> <span class="keyword ">and</span> <span class="">stick_drive</span> = <span class="keyword constant ">false</span>
                      <span class="keyword ">unless</span> <span class="">boom_out</span> <span class="keyword ">then</span> <span class="constructor">FillStickBucket</span>

                  | <span class="constructor">FillStickBucket</span> -&gt;
                      <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">stick_push</span>  <span class="keyword ">and</span> <span class="">stick_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">bucket_push</span> <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">and</span> <span class="">boom_drive</span> = <span class="keyword constant ">false</span>
                      <span class="keyword ">until</span> (<span class="">stick_out</span> <span class="operator">&&</span> <span class="">boom_out</span>) <span class="keyword ">then</span> <span class="constructor">RaiseBoom</span>

                  | <span class="constructor">RaiseBoom</span> -&gt;
                      <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">boom_pull</span> <span class="keyword ">and</span> <span class="">boom_drive</span> = <span class="keyword constant ">true</span>
                      <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">false</span> <span class="keyword ">and</span> <span class="">stick_drive</span> = <span class="keyword constant ">false</span>
                      <span class="keyword ">until</span> (<span class="">boom_in</span>) <span class="keyword ">then</span> <span class="constructor">Finished</span>

                  | <span class="constructor">Finished</span> -&gt;
                      <span class="keyword ">do</span> <span class="">finished</span> = <span class="keyword constant ">true</span> <span class="keyword ">done</span>

                <span class="keyword ">until</span> (<span class="">stop_button</span>) <span class="keyword ">then</span> <span class="constructor">Pause</span>

            | <span class="constructor">Pause</span> -&gt;
                <span class="keyword ">do</span> <span class="">alarm_lamp</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">and</span> <span class="">done_lamp</span>  = <span class="">blink2</span>(<span class="number">4</span>, <span class="number">2</span>, <span class="">second</span>)
                <span class="keyword ">and</span> <span class="">boom_drive</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">and</span> <span class="">stick_drive</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">until</span> (<span class="">extend_button</span>) <span class="keyword ">continue</span> <span class="constructor">Move</span>
                 <span class="keyword ">else</span> (<span class="">retract_button</span> || <span class="">after</span>(<span class="number">30</span>, <span class="">second</span>)) <span class="keyword ">then</span> <span class="constructor">Cancel</span>

            | <span class="constructor">Cancel</span> -&gt;
                <span class="keyword ">do</span> <span class="">cancel_lamp</span> = <span class="">blink</span>(<span class="number">1</span>, <span class="">second</span>)
                <span class="keyword ">and</span> <span class="">alarm_lamp</span> = <span class="keyword constant ">false</span>
                <span class="keyword ">and</span> <span class="">done_lamp</span>  = <span class="keyword constant ">false</span>

                <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">boom_pull</span>   <span class="keyword ">and</span> <span class="">boom_drive</span>   = <span class="keyword constant ">true</span>
                <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">stick_push</span>  <span class="keyword ">and</span> <span class="">stick_drive</span>  = <span class="keyword constant ">true</span>
                <span class="keyword ">and</span> <span class="keyword ">emit</span> <span class="">bucket_push</span> <span class="keyword ">and</span> <span class="">bucket_drive</span> = <span class="keyword constant ">true</span>

                <span class="keyword ">and</span> <span class="">finished</span> = <span class="">boom_in</span> <span class="operator">&&</span> <span class="">stick_out</span> <span class="operator">&&</span> <span class="">bucket_out</span>
                <span class="keyword ">done</span>

            <span class="keyword ">until</span> (<span class="">finished</span>) <span class="keyword ">then</span> <span class="constructor">Stable</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = () <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">sensors</span> = ((<span class="keyword constant ">false</span>, <span class="keyword constant ">false</span>), (<span class="keyword constant ">false</span>, <span class="keyword constant ">false</span>), 
                      (<span class="keyword constant ">false</span>, <span class="keyword constant ">false</span>), (<span class="keyword constant ">false</span>, <span class="keyword constant ">false</span>))
  
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">boom_drive</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">stick_drive</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">bucket_drive</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">alarm_lamp</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">done_lamp</span> = <span class="keyword constant ">false</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">cancel_lamp</span> = <span class="keyword constant ">false</span>

  <span class="keyword ">and</span> <span class="keyword ">present</span> <span class="">sample</span> -&gt; 
        <span class="keyword ">do</span> ((<span class="">boom_push</span>, <span class="">boom_pull</span>, <span class="">boom_drive</span>),
           (<span class="">stick_push</span>, <span class="">stick_pull</span>, <span class="">stick_drive</span>),
           (<span class="">bucket_push</span>, <span class="">bucket_pull</span>, <span class="">bucket_drive</span>),
           (<span class="">legs_extend</span>, <span class="">legs_retract</span>, <span class="">legs_stop</span>),
           (<span class="">alarm_lamp</span>, <span class="">done_lamp</span>, <span class="">cancel_lamp</span>)) = 
                          <span class="">sampled_controller</span> (<span class="keyword expr ">last</span> <span class="">sensors</span>, <span class="constructor">Backhoedyn</span>.<span class="">buttons</span> (), <span class="">second</span>) 
        <span class="keyword ">done</span>
		
  <span class="keyword ">and</span> <span class="">sensors</span> = 
        <span class="constructor">Backhoedyn</span>.<span class="">model</span> ((<span class="">boom_push</span>, <span class="">boom_pull</span>, <span class="">boom_drive</span>),
			  (<span class="">stick_push</span>, <span class="">stick_pull</span>, <span class="">stick_drive</span>),
			  (<span class="">bucket_push</span>, <span class="">bucket_pull</span>, <span class="">bucket_drive</span>),
			  (<span class="">legs_extend</span>, <span class="">legs_retract</span>, <span class="">legs_stop</span>),
			  (<span class="">alarm_lamp</span>, <span class="">done_lamp</span>, <span class="">cancel_lamp</span>)) 

  <span class="keyword ">and</span> <span class="">sample</span> = <span class="keyword expr ">period</span> (<span class="number">0.5</span>)

  <span class="keyword ">and</span> <span class="">second</span> = <span class="keyword ">present</span> <span class="">sample</span> -&gt; <span class="">not</span> (<span class="keyword expr ">last</span> <span class="">second</span>) <span class="keyword ">init</span> <span class="keyword constant ">true</span>

</code></pre></div></div></div></div>

<div id="backhoe-backhoedyn-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#backhoe-backhoedyn-box"
   href="#backhoe-backhoedyn"><i class="icon-file"></i> backhoedyn.zls</a>
</div>

<div id="backhoe-backhoedyn" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(** Model constants *)</span>

<span class="keyword ">let</span> <span class="">boom_rate</span>   = <span class="number">0.4</span>
<span class="keyword ">let</span> <span class="">stick_rate</span>  = <span class="number">0.5</span>
<span class="keyword ">let</span> <span class="">bucket_rate</span> = <span class="number">0.35</span>
<span class="keyword ">let</span> <span class="">leg_rate</span>    = <span class="number">4.0</span>

<span class="comment">(** Model components *)</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">segment</span> ((<span class="">min</span>, <span class="">max</span>, <span class="">i</span>), <span class="">maxf</span>, (<span class="">push</span>, <span class="">pull</span>, <span class="">go</span>))
 = ((<span class="">segin</span>, <span class="">segout</span>), <span class="">angle</span>) <span class="keyword ">where</span>

 <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">angle</span> = <span class="">v</span> <span class="keyword ">init</span> <span class="">i</span>
 <span class="keyword ">and</span> <span class="">error</span> = <span class="">v_r</span> -. <span class="">v</span>
 <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">v</span> = (<span class="number">0.7</span> <span class="operator">/.</span> <span class="">maxf</span>) <span class="operator">*.</span> <span class="">error</span> <span class="operator">+.</span> <span class="number">0.3</span> <span class="operator">*.</span> <span class="">z</span> <span class="keyword ">init</span> <span class="number">0.0</span>
             <span class="keyword ">reset</span> <span class="">hit</span>(<span class="">v0</span>) -&gt; <span class="">v0</span>
 <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">z</span> = <span class="">error</span> <span class="keyword ">init</span> <span class="number">0.0</span> <span class="keyword ">reset</span> <span class="">hit</span>(_) -&gt; <span class="number">0.0</span>
 <span class="keyword ">and</span> <span class="">v_r</span> = <span class="keyword ">if</span> <span class="">go</span> <span class="keyword ">then</span> <span class="">rate</span> <span class="keyword ">else</span> <span class="number">0.0</span>
 <span class="keyword ">and</span> <span class="keyword ">init</span> (<span class="">segin</span>, <span class="">segout</span>) = (<span class="">angle</span> <span class="operator"><=</span> <span class="">min</span>, <span class="">angle</span> <span class="operator">>=</span> <span class="">max</span>)

 <span class="keyword ">and</span> <span class="keyword ">automaton</span>
   | <span class="constructor">Stuck</span> -&gt; <span class="keyword ">do</span>
        <span class="">rate</span> = <span class="number">0.0</span>
      <span class="keyword ">until</span> <span class="">push</span>() <span class="keyword expr ">on</span> (<span class="">angle</span> &lt; <span class="">max</span>) <span class="keyword ">then</span>
        <span class="keyword ">do</span> <span class="">segin</span> = <span class="keyword constant ">false</span> <span class="keyword ">and</span> <span class="">segout</span> = <span class="keyword constant ">false</span> <span class="keyword ">in</span> <span class="constructor">Pushing</span>
      <span class="keyword ">else</span>  <span class="">pull</span>() <span class="keyword expr ">on</span> (<span class="">angle</span> &gt; <span class="">min</span>) <span class="keyword ">then</span>
        <span class="keyword ">do</span> <span class="">segin</span> = <span class="keyword constant ">false</span> <span class="keyword ">and</span> <span class="">segout</span> = <span class="keyword constant ">false</span> <span class="keyword ">in</span> <span class="constructor">Pulling</span>

   | <span class="constructor">Pushing</span> -&gt; <span class="keyword ">local</span> <span class="">atlimit</span> <span class="keyword ">in</span>
      <span class="keyword ">do</span>
        <span class="">rate</span> = <span class="">maxf</span>
        <span class="keyword ">and</span> <span class="">atlimit</span> = <span class="keyword expr ">up</span>(<span class="">angle</span> -. <span class="">max</span>)
      <span class="keyword ">until</span> <span class="">atlimit</span> <span class="keyword expr ">on</span> (<span class="keyword expr ">last</span> <span class="">v</span> &gt; <span class="number">0.3</span> <span class="operator">*.</span> <span class="">maxf</span>) <span class="keyword ">then</span> <span class="keyword ">do</span>
               <span class="keyword ">emit</span> <span class="">hit</span> = -<span class="number">0.8</span> <span class="operator">*.</span> <span class="keyword expr ">last</span> <span class="">v</span> <span class="keyword ">in</span> <span class="constructor">Pushing</span>
      <span class="keyword ">else</span> (<span class="">atlimit</span>) <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="">segout</span> = <span class="keyword constant ">true</span> <span class="keyword ">in</span> <span class="constructor">Stuck</span>
      <span class="keyword ">else</span> <span class="">pull</span>() <span class="keyword ">then</span> <span class="constructor">Pulling</span>

   | <span class="constructor">Pulling</span> -&gt; <span class="keyword ">local</span> <span class="">atlimit</span> <span class="keyword ">in</span>
      <span class="keyword ">do</span>
        <span class="">rate</span> = -. <span class="">maxf</span>
        <span class="keyword ">and</span> <span class="">atlimit</span> = <span class="keyword expr ">up</span>(<span class="">min</span> -. <span class="">angle</span>)
      <span class="keyword ">until</span> <span class="">atlimit</span> <span class="keyword expr ">on</span> (<span class="keyword expr ">last</span> <span class="">v</span> &lt; -<span class="number">0.3</span> <span class="operator">*.</span> <span class="">maxf</span>) <span class="keyword ">then</span> <span class="keyword ">do</span>
               <span class="keyword ">emit</span> <span class="">hit</span> = -<span class="number">0.8</span> <span class="operator">*.</span> <span class="keyword expr ">last</span> <span class="">v</span> <span class="keyword ">in</span> <span class="constructor">Pulling</span>
      <span class="keyword ">else</span>  (<span class="">atlimit</span>) <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="">segin</span> = <span class="keyword constant ">true</span> <span class="keyword ">in</span> <span class="constructor">Stuck</span>
      <span class="keyword ">else</span>  <span class="">push</span>() <span class="keyword ">then</span> <span class="constructor">Pushing</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">legsegment</span> ((<span class="">min</span>, <span class="">max</span>, <span class="">i</span>), <span class="">rate</span>, (<span class="">extend</span>, <span class="">retract</span>, <span class="">stop</span>)) =
  ((<span class="">segin</span>, <span class="">segout</span>), <span class="">pos</span>) <span class="keyword ">where</span>

  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">pos</span> = <span class="">i</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">segin</span>  = <span class="">pos</span> <span class="operator"><=</span> <span class="">min</span>
  <span class="keyword ">and</span> <span class="keyword ">init</span> <span class="">segout</span> = <span class="">pos</span> <span class="operator">>=</span> <span class="">max</span>

  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
    | <span class="constructor">Stationary</span> -&gt;
        <span class="keyword ">do</span>
          <span class="keyword ">der</span> <span class="">pos</span> = <span class="number">0.0</span>
        <span class="keyword ">until</span> <span class="">extend</span>() <span class="keyword expr ">on</span> (<span class="">not</span> <span class="">segout</span>)
          <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">segin</span> = <span class="keyword constant ">false</span> <span class="keyword ">in</span> <span class="constructor">Extending</span>
        <span class="keyword ">else</span>  <span class="">retract</span>() <span class="keyword expr ">on</span> (<span class="">not</span> <span class="">segin</span>)
          <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">segout</span> = <span class="keyword constant ">false</span> <span class="keyword ">in</span> <span class="constructor">Retracting</span>

    | <span class="constructor">Extending</span> -&gt;
        <span class="keyword ">do</span>
          <span class="keyword ">der</span> <span class="">pos</span> = <span class="">rate</span>
        <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">pos</span> -. <span class="">max</span>)
          <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">segout</span> = <span class="keyword constant ">true</span> <span class="keyword ">in</span> <span class="constructor">Stationary</span>
        <span class="keyword ">else</span>  <span class="">stop</span>()         <span class="keyword ">then</span> <span class="constructor">Stationary</span>
        <span class="keyword ">else</span>  <span class="">retract</span>()      <span class="keyword ">then</span> <span class="constructor">Retracting</span>

    | <span class="constructor">Retracting</span> -&gt;
        <span class="keyword ">do</span>
          <span class="keyword ">der</span> <span class="">pos</span> = -. <span class="">rate</span>
        <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">min</span> -. <span class="">pos</span>) <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">next</span> <span class="">segin</span> = <span class="keyword constant ">true</span> <span class="keyword ">in</span> <span class="constructor">Stationary</span>
        <span class="keyword ">else</span>  <span class="">stop</span>()         <span class="keyword ">then</span> <span class="constructor">Stationary</span>
        <span class="keyword ">else</span>  <span class="">extend</span>()       <span class="keyword ">then</span> <span class="constructor">Extending</span>


<span class="comment">(** Put the model together and link it to the GUI *)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Backhoegui</span>

<span class="keyword ">let</span> <span class="keyword ">node</span> <span class="">buttons</span> () = <span class="">showsample</span> ()

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">model</span>
  (<span class="">boom_control</span>, <span class="">stick_control</span>, <span class="">bucket_control</span>, <span class="">leg_control</span>, <span class="">lamp_control</span>) =

  <span class="keyword ">let</span> (<span class="">boom_sensors</span>, <span class="">boom_ang</span>)
      = <span class="">segment</span> (<span class="">boom_range</span>, <span class="">boom_rate</span>, <span class="">boom_control</span>)

  <span class="keyword ">and</span> (<span class="">stick_sensors</span>, <span class="">stick_ang</span>)
      = <span class="">segment</span> (<span class="">stick_range</span>, <span class="">stick_rate</span>, <span class="">stick_control</span>)

  <span class="keyword ">and</span> (<span class="">bucket_sensors</span>, <span class="">bucket_ang</span>)
      = <span class="">segment</span> (<span class="">bucket_range</span>, <span class="">bucket_rate</span>, <span class="">bucket_control</span>)

  <span class="keyword ">and</span> (<span class="">leg_sensors</span>, <span class="">leg_pos</span>)
      = <span class="">legsegment</span> (<span class="">leg_range</span>, <span class="">leg_rate</span>, <span class="">leg_control</span>)

  <span class="keyword ">and</span> <span class="">refresh_rate</span> = <span class="keyword expr ">period</span> (<span class="number">0.1</span>) <span class="keyword ">in</span>

  <span class="keyword ">let</span>
  <span class="keyword ">rec</span> (<span class="">alarm_lamp</span>, <span class="">done_lamp</span>, <span class="">cancel_lamp</span>) = <span class="">lamp_control</span>
  <span class="keyword ">and</span> _ =
    <span class="keyword ">present</span>
    | <span class="">refresh_rate</span> -&gt;
          <span class="">showupdate</span> (<span class="">leg_pos</span>, <span class="">boom_ang</span>, <span class="">stick_ang</span>, <span class="">bucket_ang</span>,
                               <span class="">alarm_lamp</span>, <span class="">done_lamp</span>, <span class="">cancel_lamp</span>)
  <span class="keyword ">in</span>
  (<span class="">leg_sensors</span>, <span class="">boom_sensors</span>, <span class="">stick_sensors</span>, <span class="">bucket_sensors</span>)

</code></pre></div></div></div></div>

<p>Further details can be found in the paper <a href="papers.html#HSCC2013">Zélus: A Synchronous Language
with ODEs</a>.</p>
</div><hr />
<div id="airtraffic" class="example-section">
<h2 id="airtrafficcontrol">Airtraffic Control</h2>

<div class="requirements">
<p class="text-info">
<i class="icon-info-sign"></i> <em>Requires</em>:
Lablgtk2</p>
</p>
</div>

<p>This example is taken from the paper: <a href="http://dx.doi.org/10.1109/9.664154"><em>Conflict Resolution for Air Traffic
Management: A Case Study in Multiagent Hybrid
Systems</em></a>, Tomlin, Pappas, Sastry, 1998.</p>

<p>It models a <em>conflict resolution manouever</em> for two planes: Aircraft1 and
Aircraft2. Both aircraft are flying at a similar altitude and with constant
velocity and heading. Two zones are defined around each aircraft:</p>

<p><img src="img/aircraft-zones.png" alt="Plane alert zones" title="Plane alert zones" id="planealertzones" /></p>

<p>A conflict resolution manouever is considered when two planes have entered
into each other's alert zones. The system aims to ensure that neither plane
ever enters the other's protected zone.</p>

<p>In the model, the position and heading of Aircraft1 define, respectively, the
origin and direction of the positive x-axis of a relative coordinate system,
in which the position of Aircraft2 is specified. The heading of Aircraft2 is
specified relative to the positive x-axis.</p>

<p><img src="img/aircraft-model.png" alt="Basic model" title="Basic model" id="basicmodel" /></p>

<p>The initial condition in the model is that the aircraft are cruising outside
each other's protected zones, but inside each other's alert zones.</p>

<p>The manouever modelled in this case is (taken directly from the paper):</p>

<ol>
<li><p><em>Cruise</em></p>

<p>Cruise until aircraft are <code>alpha1</code> miles apart.</p></li>
<li><p><em>Left</em></p>

<p>Make a heading change of <code>delta_phi</code> and fly until a lateral displacement
of at least <code>d</code> miles is acheived for both aircraft.</p></li>
<li><p><em>Straight</em></p>

<p>Make a heading change to the original heading and fly until the aircraft
are <code>alpha2</code> miles apart.</p></li>
<li><p><em>Right</em></p>

<p>Make a heading change of <code>-delta_phi</code> and fly until a lateral
displacement of d miles is acheived for both aircraft.</p></li>
<li><p><em>Cruise</em></p>

<p>Make a heading change to original heading and cruise.</p></li>
</ol>

<p>Note that, in the model at least, the heading changes occur simultaneously
and instantaneously.</p>

<div id="airtraffic-airtraffic-box" class="accordion sourcefile">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle" data-toggle="collapse"
   data-parent="#airtraffic-airtraffic-box"
   href="#airtraffic-airtraffic"><i class="icon-file"></i> airtraffic.zls</a>
</div>

<div id="airtraffic-airtraffic" class="accordion-body">
<div class="accordion-inner">
<pre class="zelus "><code><span class="comment">(*
 * This example is taken from the paper:
 *   <span class="string">"Conflict Resolution in Air Traffic Management; A Study in Multiagent
 *    Hybrid Systems"</span>, Tomlin, Pappas, Sastry, 1998
 *)</span>

<span class="comment">(** constants, initial state **)</span>

<span class="keyword ">let</span> <span class="">pi</span> = <span class="number">4.0</span> <span class="operator">*.</span> <span class="">atan</span> <span class="number">1.0</span>

<span class="keyword ">let</span> <span class="">d</span> = <span class="number">10.0</span>                <span class="comment">(* distance to deviate for avoidance, in miles *)</span>
<span class="keyword ">let</span> <span class="">delta_phi</span> = (<span class="">pi</span> <span class="operator">/.</span> <span class="number">4.0</span>) <span class="comment">(* change in heading for avoidance, radians *)</span>

<span class="keyword ">let</span> <span class="">radius_protected</span> = <span class="number">5.0</span>  <span class="comment">(* radius of the protected zone, in miles *)</span>
<span class="keyword ">let</span> <span class="">radius_alert</span> = <span class="number">25.0</span>     <span class="comment">(* radius of the alert zone, in miles *)</span>

<span class="keyword ">let</span> <span class="">alpha1</span> = <span class="number">16.0</span>           <span class="comment">(* distance at which avoidance is triggered *)</span>
<span class="keyword ">let</span> <span class="">alpha2</span> = <span class="number">20.0</span>           <span class="comment">(* distance at which avoidance is terminated *)</span>

<span class="comment">(* velocity in miles/hour converted to miles/minute *)</span>
<span class="keyword ">let</span> <span class="">aircraft1_v</span> = <span class="number">540.0</span> <span class="operator">/.</span> <span class="number">3600.0</span> <span class="comment">(* velocity of aircraft1 *)</span>
<span class="keyword ">let</span> <span class="">aircraft2_v</span> = <span class="number">570.0</span> <span class="operator">/.</span> <span class="number">3600.0</span> <span class="comment">(* velocity of aircraft2 *)</span>

<span class="comment">(* initial position of aircraft2, relative to aircraft1 *)</span>
<span class="keyword ">let</span> <span class="">aircraft2_xi</span> = <span class="number">60.0</span>
<span class="keyword ">let</span> <span class="">aircraft2_yi</span> = <span class="number">28.0</span>
<span class="keyword ">let</span> <span class="">aircraft2_thetai</span> = -. <span class="number">3.0</span> <span class="operator">*.</span> <span class="">pi</span> <span class="operator">/.</span> <span class="number">4.0</span>

<span class="comment">(** algorithm **)</span>

<span class="keyword ">let</span> <span class="">rotate</span> (<span class="">theta</span>, <span class="">x</span>, <span class="">y</span>) = (<span class="">x'</span>, <span class="">y'</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">cos_theta</span> = <span class="">cos</span>(<span class="">theta</span>)
  <span class="keyword ">and</span> <span class="">sin_theta</span> = <span class="">sin</span>(<span class="">theta</span>)
  <span class="keyword ">and</span> <span class="">x'</span> = (<span class="">cos_theta</span> <span class="operator">*.</span> <span class="">x</span>) <span class="operator">+.</span> (-. <span class="">sin_theta</span> <span class="operator">*.</span> <span class="">y</span>)
  <span class="keyword ">and</span> <span class="">y'</span> = (<span class="">sin_theta</span> <span class="operator">*.</span> <span class="">x</span>) <span class="operator">+.</span> (<span class="">cos_theta</span> <span class="operator">*.</span> <span class="">y</span>)

<span class="keyword ">let</span> <span class="">rotate_x</span> (<span class="">theta</span>, <span class="">x</span>, <span class="">y</span>) = (<span class="">cos</span>(<span class="">theta</span>) <span class="operator">*.</span> <span class="">x</span>) <span class="operator">+.</span> (-. <span class="">sin</span>(<span class="">theta</span>) <span class="operator">*.</span> <span class="">y</span>)
<span class="keyword ">let</span> <span class="">rotate_y</span> (<span class="">theta</span>, <span class="">x</span>, <span class="">y</span>) = (<span class="">sin</span>(<span class="">theta</span>) <span class="operator">*.</span> <span class="">x</span>) <span class="operator">+.</span> (<span class="">cos</span>(<span class="">theta</span>) <span class="operator">*.</span> <span class="">y</span>)

<span class="keyword ">let</span> <span class="">sqr</span> <span class="">x</span> = <span class="">x</span> <span class="operator">*.</span> <span class="">x</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">integr</span>(<span class="">x'</span>, <span class="">x0</span>) = <span class="">x</span> <span class="keyword ">where</span> <span class="keyword ">rec</span> <span class="keyword ">der</span> <span class="">x</span> = <span class="">x'</span> <span class="keyword ">init</span> <span class="">x0</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">avoidance</span> (<span class="">x_i</span>, <span class="">y_i</span>, <span class="">theta_i</span>, <span class="">v_1</span>, <span class="">v_2</span>) = (<span class="">st</span>, <span class="">x</span>, <span class="">y</span>, <span class="">theta</span>, <span class="">t</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="keyword ">init</span> <span class="">theta</span> = <span class="">theta_i</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x</span> = -. <span class="">v_1</span> <span class="operator">+.</span> <span class="">v_2</span> <span class="operator">*.</span> <span class="">cos</span>(<span class="">theta</span>) <span class="keyword ">init</span> <span class="">x_i</span> <span class="keyword ">reset</span> <span class="">nxy</span>(<span class="">nx</span>, _) -&gt; <span class="">nx</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">y</span> = <span class="">v_2</span> <span class="operator">*.</span> <span class="">sin</span>(<span class="">theta</span>) <span class="keyword ">init</span> <span class="">y_i</span> <span class="keyword ">reset</span> <span class="">nxy</span>(_, <span class="">ny</span>) -&gt; <span class="">ny</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">t</span> = <span class="">t'</span> <span class="keyword ">init</span> <span class="number">0.0</span>
  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      | <span class="constructor">Cruise</span> -&gt;
          <span class="keyword ">do</span>
            <span class="">t'</span> = <span class="number">0.0</span>
            <span class="keyword ">and</span> <span class="">st</span> = <span class="number">0</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">sqr</span>(<span class="">alpha1</span>) -. <span class="">sqr</span>(<span class="keyword expr ">last</span> <span class="">x</span>) -. <span class="">sqr</span>(<span class="keyword expr ">last</span> <span class="">y</span>))
            <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">nxy</span> = <span class="">rotate</span>(-. <span class="">delta_phi</span>, <span class="keyword expr ">last</span> <span class="">x</span>, <span class="keyword expr ">last</span> <span class="">y</span>) <span class="keyword ">in</span> <span class="constructor">Left</span>
      | <span class="constructor">Left</span> -&gt;
          <span class="keyword ">local</span> <span class="">t1</span>, <span class="">t2</span> <span class="keyword ">in</span>
          <span class="keyword ">do</span>
            <span class="">t1</span> = <span class="">d</span> <span class="operator">/.</span> (<span class="">v_1</span> <span class="operator">*.</span> <span class="">sin</span>(<span class="">delta_phi</span>))
            <span class="keyword ">and</span> <span class="">t2</span> = <span class="">d</span> <span class="operator">/.</span> (<span class="">v_2</span> <span class="operator">*.</span> <span class="">sin</span>(<span class="">delta_phi</span>))
            <span class="keyword ">and</span> <span class="">t'</span> = <span class="number">1.0</span>
            <span class="keyword ">and</span> <span class="">st</span> = <span class="number">1</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">t</span> -. <span class="">t1</span>)
            <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">nxy</span> = <span class="">rotate</span>(<span class="">delta_phi</span>, <span class="keyword expr ">last</span> <span class="">x</span>, <span class="keyword expr ">last</span> <span class="">y</span>) <span class="keyword ">in</span> <span class="constructor">Straight</span>
          <span class="keyword ">else</span>  <span class="keyword expr ">up</span>(<span class="">t</span> -. <span class="">t2</span>)
            <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">nxy</span> = <span class="">rotate</span>(<span class="">delta_phi</span>, <span class="keyword expr ">last</span> <span class="">x</span>, <span class="keyword expr ">last</span> <span class="">y</span>) <span class="keyword ">in</span> <span class="constructor">Straight</span>
      | <span class="constructor">Straight</span> -&gt;
          <span class="keyword ">do</span>
            <span class="">t'</span> = <span class="number">0.0</span>
            <span class="keyword ">and</span> <span class="">st</span> = <span class="number">2</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span>(<span class="">sqr</span>(<span class="keyword expr ">last</span> <span class="">x</span>) <span class="operator">+.</span> <span class="">sqr</span>(<span class="keyword expr ">last</span> <span class="">y</span>) -. <span class="">sqr</span>(<span class="">alpha2</span>))
            <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">nxy</span> = <span class="">rotate</span>(<span class="">delta_phi</span>, <span class="keyword expr ">last</span> <span class="">x</span>, <span class="keyword expr ">last</span> <span class="">y</span>) <span class="keyword ">in</span> <span class="constructor">Right</span>
      | <span class="constructor">Right</span> -&gt;
          <span class="keyword ">do</span>
            <span class="">t'</span> = -. <span class="number">1.0</span>
            <span class="keyword ">and</span> <span class="">st</span> = <span class="number">3</span>
          <span class="keyword ">until</span> <span class="keyword expr ">up</span>(-. <span class="">t</span>)
            <span class="keyword ">then</span> <span class="keyword ">do</span> <span class="keyword ">emit</span> <span class="">nxy</span> = <span class="">rotate</span>(-. <span class="">delta_phi</span>, <span class="keyword expr ">last</span> <span class="">x</span>, <span class="keyword expr ">last</span> <span class="">y</span>) <span class="keyword ">in</span> <span class="constructor">Cruise</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">noavoidance</span> (<span class="">x_i</span>, <span class="">y_i</span>, <span class="">theta_i</span>, <span class="">v_1</span>, <span class="">v_2</span>) = (<span class="number">0</span>, <span class="">x</span>, <span class="">y</span>, <span class="">theta</span>, <span class="">t</span>) <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">theta</span> = <span class="">theta_i</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">x</span> = -. <span class="">v_1</span> <span class="operator">+.</span> <span class="">v_2</span> <span class="operator">*.</span> <span class="">cos</span>(<span class="">theta</span>) <span class="keyword ">init</span> <span class="">x_i</span>
  <span class="keyword ">and</span> <span class="keyword ">der</span> <span class="">y</span> = <span class="">v_2</span> <span class="operator">*.</span> <span class="">sin</span>(<span class="">theta</span>) <span class="keyword ">init</span> <span class="">y_i</span>
  <span class="keyword ">and</span> <span class="">t</span> = <span class="number">0.0</span>

<span class="comment">(** Animation **)</span>

<span class="keyword keyword module ">open</span> <span class="constructor">Airtrafficgui</span>

<span class="keyword ">let</span> <span class="keyword ">hybrid</span> <span class="">main</span> () = () <span class="keyword ">where</span>
  <span class="keyword ">rec</span> <span class="">p</span> = <span class="keyword expr ">period</span> (<span class="number">1.0</span>)

  <span class="keyword ">and</span> (<span class="">click</span>, (<span class="">nxr</span>, <span class="">nyr</span>), (<span class="">ntheta_r</span>, <span class="">nd</span>)) =
    <span class="keyword ">present</span> <span class="">p</span> -&gt; <span class="">sample</span> ()
    <span class="keyword ">init</span> (<span class="keyword constant ">false</span>, (<span class="">aircraft2_xi</span>, <span class="">aircraft2_yi</span>), (<span class="">aircraft2_thetai</span>, <span class="number">0.0</span>))

  <span class="keyword ">and</span> <span class="keyword ">automaton</span>
      <span class="constructor">S1</span> -&gt; <span class="keyword ">do</span>
        (<span class="">st</span>, <span class="">xr</span>, <span class="">yr</span>, <span class="">theta_r</span>, <span class="">t</span>) =
          <span class="">avoidance</span> (<span class="">nxr</span>, <span class="">nyr</span>, <span class="">ntheta_r</span>, <span class="">aircraft1_v</span>, <span class="">aircraft2_v</span>)
      <span class="keyword ">until</span> <span class="">p</span> <span class="keyword expr ">on</span> <span class="">click</span> <span class="keyword ">then</span> <span class="constructor">S1</span>

  <span class="keyword ">and</span> _ = <span class="keyword ">present</span> <span class="">p</span> -&gt; <span class="">showupdate</span> (<span class="">d</span>, <span class="">delta_phi</span>, <span class="">radius_alert</span>, <span class="">radius_protected</span>, <span class="number">0.0</span>,
                                   <span class="">st</span>, <span class="">xr</span>, <span class="">yr</span>, <span class="">theta_r</span>, <span class="">aircraft1_v</span>, <span class="">aircraft2_v</span>, <span class="">t</span>)

</code></pre></div></div></div></div>
</div><hr />
</div><!--/span-->
</div><!--/row-->
</div><!--/.fluid-container-->


<!-- Placed at the end of the document so the pages load faster -->
<script src="./js/jquery.js"></script>
<script src="./js/bootstrap.min.js"></script>

<script>
$(".accordion-body").each(function() {
    $(this).addClass("collapse");
  })

$(document).ready(function () {
  $('.accordion').on('shown hidden', function () {
    $('body').scrollspy('refresh');
  });
});
</script>

</body>
</html>
