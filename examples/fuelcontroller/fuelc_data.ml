(*
  Period, in `physical-time', of logical clock ticks for executing the
  fuel_rate_controller. Simulink handles this in a better way by setting the
  sample-time using a Rate Transition Block with an explicit 'output port sample
  time', and then using sample-time inheritance to propagate the setting
  throughout the model.
 *)

let fuelc_period = 0.01

let speed_vect = [|  50;  75; 100; 125; 150; 175; 200; 250; 300; 350;
                    400; 450; 500; 600; 700; 800; 900; 1000 |]

let press_vect = [| 0.05; 0.1; 0.15; 0.2; 0.25; 0.3; 0.35; 0.4; 0.45; 0.5;
                    0.55; 0.6; 0.65; 0.7; 0.75; 0.8; 0.85; 0.9; 0.95 |]

let throt_vect = [|  0;  3;  6;  9; 12; 15; 18; 21; 24;
                    27; 30; 35; 46; 57; 68; 79; 90 |]

(* parameters

   see sldemo_fuelsys_data.m:
     td = sldemo_fuelsys_data('sldemo_fuelsys','get_table_data')
     min_press = max(min(td.PressVect), 0.05)
     max_press = min(max(td.PressVect), 1)
     min_speed = max(min(td.SpeedVect), 0)
     max_speed = 628
     min_throt = max(min(td.ThrotVect), 3)
     max_throt = min(max(td.ThrotVect), 90)
     max_ego = 1.2
     zero_thresh = 250
     hys = 25
*)
let amin a = Array.fold_left min a.(0) a
let amax a = Array.fold_left max a.(0) a

let min_press   = max (amin press_vect) 0.05
let max_press   = min (amax press_vect) 1.00
let min_speed   = max (amin speed_vect) 0
let max_speed   = 628
let min_throt   = max (amin throt_vect)  3
let max_throt   = min (amax throt_vect) 90

let max_ego     = 1.2
let zero_thresh = 250
let hys         = 25

(* press_est.(speed_vect).(throt_vect) *)
let press_est = [|
[| 0.806253176323533; 0.877575986013820; 0.957740646602364; 0.985153049483995;
   0.993888908359001; 0.997089947885844; 0.998445305205399; 0.999091830797014;
   0.999430938454035; 0.999622818995239; 0.999738270814208; 0.999845542107005;
   0.999937181505709; 0.999967346454435; 0.999979873928593; 0.999985850596962;
   0.999988872471833 |];

[| 0.553142316928701; 0.687048893636338; 0.884928073705099; 0.959498363205152;
   0.983356257320681; 0.992081090207251; 0.995771008698205; 0.997530140187631;
   0.998452542678774; 0.998974388477469; 0.999288345380530; 0.999580035742161;
   0.999829204284437; 0.999911219910389; 0.999945280453193; 0.999961530125998;
   0.999969746130731 |];

[| 0.371515002089540; 0.482612303368962; 0.772510257347488; 0.917829220630290;
   0.966202131946129; 0.983928124711611; 0.991420178702962; 0.994990142355732;
   0.996861498829361; 0.997920027607395; 0.998556801019289; 0.999148366829447;
   0.999653659903192; 0.999819973435009; 0.999889041260296; 0.999921992055277;
   0.999938652267344 |];

[| 0.277667903102846; 0.354224278507773; 0.634596441906303; 0.858155181125974;
   0.941196863973347; 0.972020092047905; 0.985064576930091; 0.991280051853728;
   0.994537692220384; 0.996380159664924; 0.997488437655209; 0.998517971150347;
   0.999397308920136; 0.999686725882367; 0.999806915357152; 0.999864254875951;
   0.999893246159778 |];

[| 0.220198954206677; 0.278413460665919; 0.499509252438175; 0.780915653069415;
   0.907255069630590; 0.955734788592824; 0.976359298715029; 0.986196279487014;
   0.991353075497716; 0.994269777477944; 0.996024221776188; 0.997653989166547;
   0.999045967737845; 0.999504103593618; 0.999694357753908; 0.999785123212449;
   0.99983101483727 |];

[| 0.181288665766343; 0.227999583948868; 0.398952953853525; 0.690639436957016;
   0.863705911066113; 0.934478804869502; 0.964951264217872; 0.979525847256624;
   0.987172517967595; 0.991498792106339; 0.994101447273549; 0.996519319760225;
   0.998584517171801; 0.999264242683749; 0.999546520327838; 0.999681188248569;
   0.999749277343391 |];

[| 0.153200000488606; 0.191995727776301; 0.330914655151405; 0.595646844312617;
   0.810666723282258; 0.907750463187950; 0.950492505538488; 0.971050093756693;
   0.981855086965011; 0.987972552524888; 0.991653973147472; 0.995074698970308;
   0.997996914902605; 0.998958792355415; 0.999358253074229; 0.999548828343865;
   0.999645185116666 |];

[| 0.115431020871550; 0.144034515174401; 0.243979118856238; 0.429790108547636;
   0.682438642375562; 0.836880642957011; 0.911180328436110; 0.947813899384122;
   0.967228564640520; 0.978257580098748; 0.984905309066455; 0.991088428442116;
   0.996374579118731; 0.998115314543176; 0.998838330528732; 0.999183288382611;
   0.999357707498247 |];

[| 0.0913067476324093; 0.113642314330893; 0.190658230936961; 0.328784286386920;
   0.5450744670529330; 0.744624092463580; 0.856657795837454; 0.914883507463120;
   0.9463180977478960; 0.964311517705744; 0.975196237184309; 0.985342971016168;
   0.9940329625855610; 0.996897338116608; 0.998087432486324; 0.998655313115969;
   0.9989424657020290 |];

[| 0.074651918860657; 0.0927600764089701; 0.154689629202074; 0.263508735453851;
   0.428509373032026; 0.6391871529836570; 0.787142203938478; 0.871145323822850;
   0.918076257202549; 0.9453278881275940; 0.961925625193849; 0.977463094595001;
   0.990813081836746; 0.9952212107494370; 0.997053747988697; 0.997928394076558;
   0.998370715394031 |];

[| 0.0625231108323717; 0.0776005353603968; 0.128882197432187; 0.217821230748895;
   0.3492656704965300; 0.5330264147976810; 0.705799478369783; 0.816462064121936;
   0.8817514595460420; 0.9205837842699110; 0.944507657720157; 0.967061575702449;
   0.9865446381007010; 0.9929963965141120; 0.995680976286613; 0.996962784812372;
   0.9976111336554270 |];

[| 0.0533383634276856; 0.0661461394956957; 0.109538590799923; 0.184122679716060;
   0.2925521984344700; 0.4407547880551340; 0.618550870186323; 0.752132326009762;
   0.8371278157115640; 0.8895467788418320; 0.922421304962653; 0.953755223844687;
   0.9810484338570610; 0.9901261048858570; 0.993908561852908; 0.995715616100314;
   0.9966298899412590 |];

[| 0.0461719046290558; 0.057223327839534; 0.0945575552493262; 0.158314103258091;
   0.2499552676983370; 0.372825322079962; 0.5322552575341700; 0.681013721820078;
   0.7847602411366010; 0.852005161999648; 0.8952753065456210; 0.937186788001516;
   0.9741397121193630; 0.986508158488532; 0.9916720181038670; 0.994141054504847;
   0.9953907436858470 |];

[| 0.0357830207157614; 0.0443099388567923; 0.0730034651165902;0.121584753293742;
   0.1904114971535180; 0.2806112991704440; 0.3943981419655050;0.534281588633688;
   0.6633658300909470; 0.7588972795000080; 0.8253460089398080;0.893138430722029;
   0.9553457410698940; 0.9766009292100050; 0.9855316543263220;0.989812926442846;
   0.9919825488352140 |];

[| 0.0286869137234658; 0.0355034233512583;0.0583848257268498;0.0969201999867393;
   0.1510465469512500; 0.2210788627902890;0.3077943243721020;0.4126023655203820;
   0.5362334873365720; 0.6494027104108080;0.7369197122910590;0.8337570849964490;
   0.9287735632412510; 0.9624022658365810;0.9766850814306940;0.9835621063463400;
   0.9870543690210000 |];

[| 0.0235863306154347; 0.0291800197474993; 0.047925624770081;0.0793847279015545;
   0.1233261193573440; 0.1797273540978580; 0.248796241080163;0.3310183640472790;
   0.4272443820418400; 0.5371344007745590; 0.637336655478509;0.7603353365416180;
   0.8933598831148230; 0.9430662217762580; 0.964537074160009;0.9749457425980100;
   0.9802483257290170 |];

[| 0.0197778405659999; 0.0244618918010893;0.0401408494783853;0.0663889743999435;
   0.1029118379984000; 0.1495402169253070;0.2062326245556730;0.2730874216427310;
   0.3503672285650580; 0.4385411444098060;0.5367000253235070;0.6770286410584950;
   0.8486685306876830; 0.9178676683075080;0.9485089142262480;0.9635128246575800;
   0.9711922485241430 |];

[| 0.0168486334481795; 0.0208349512025066;0.0341670824865201;0.0564468168291609;
   0.0873631839769212; 0.1266850250434630;0.1742578117545560;0.2300045810957000;
   0.2939313777724800; 0.3661382417091430;0.4468377197524500;0.5899753317472870;
   0.7951754199243480; 0.8863198992135460;0.9280876836135870;0.9488293611641990;
   0.9595154541697810 |]
|]

(* pump_con.(speed_vect).(press_vect) *)
let pump_con = [|
[| -0.0556348; 0.0185328; 0.0419484; 0.052676;
    0.0583284; 0.0614432; 0.0631079428571428; 0.0638664;
    0.0640206666666667; 0.063752; 0.0631757454545454; 0.0623688;
    0.0613844; 0.0602605714285714; 0.0590252; 0.0576992;
    0.0562985647058824; 0.0548357333333333; 0.0533205263157895 |];

[| -0.00228280000000001; 0.0465088; 0.0614657333333333; 0.067964;
    0.0710788; 0.0725018666666667; 0.0729582285714286; 0.0728104;
    0.0722597777777778; 0.0714272; 0.0703895636363636; 0.0691981333333333;
    0.0678884; 0.0664857142857143; 0.0650086666666667; 0.0634712;
    0.0618839764705882; 0.0602552888888889; 0.0585916842105263 |];

[| 0.0256932; 0.0617968; 0.0725244; 0.076908;
   0.078754; 0.0793312; 0.0791833714285714; 0.0785824;
   0.0776793333333333; 0.0765648; 0.0752964727272727; 0.0739128;
   0.0724404; 0.0708982857142857; 0.0693004; 0.0676572;
   0.0659766823529412; 0.0642650666666667; 0.0625272631578948 |];

[| 0.0435188; 0.0720096; 0.0801996; 0.0833144;
   0.08439912; 0.0844688; 0.0839584571428571; 0.0830856;
   0.0819710666666667; 0.08068736; 0.0792806181818182; 0.0777816;
   0.0762116; 0.0745858285714286; 0.07291544; 0.0712088;
   0.0694723058823529; 0.0677109333333333; 0.0659286105263158 |];

[| 0.0562692; 0.0796848; 0.0861830666666667; 0.088452;
   0.0890292; 0.0887605333333333; 0.0880085142857143; 0.0869544;
   0.0856988888888889; 0.0843024; 0.0828033818181818; 0.0812274666666667;
   0.0795924; 0.0779108571428572; 0.0761921333333333; 0.0744432;
   0.0726693882352941; 0.0708748444444444; 0.0690628421052632 |];

[| 0.0661194857142857; 0.0859099428571428;0.0911998285714286;0.0928645714285714;
   0.0930792571428571; 0.0925689142857143;0.0916442693877551;0.0904606857142857;
   0.0891044761904762; 0.0876274285714286;0.0860624987012987;0.0844316571428571;
   0.0827501142857143; 0.0810287346938776;0.0792754857142857;0.0774963428571428;
   0.0756958756302521; 0.0738776380952381; 0.0720444360902256 |];

[| 0.0741572; 0.0912288; 0.0956124; 0.096824;
   0.0967668; 0.0960752; 0.0950210857142857; 0.0937404;
   0.0923086666666667; 0.0907712; 0.0891568363636364; 0.0874848;
   0.0857684; 0.0840171428571429; 0.082238; 0.0804362;
   0.0786157411764706; 0.0767797333333334; 0.0749306315789474 |];

[| 0.08697; 0.1002352; 0.10335; 0.1039272;
   0.10348936; 0.102544; 0.101308628571429; 0.099892;
   0.0983545333333333; 0.09673248; 0.0950489090909091; 0.0933192;
   0.091554; 0.0897609142857143; 0.08794552; 0.086112;
   0.0842635529411765; 0.0824026666666667; 0.0805313052631579 |];

[| 0.0972452; 0.1079728; 0.110241733333333; 0.110396;
   0.1097044; 0.108589866666667; 0.107233657142857; 0.1057264;
   0.104118444444444; 0.10244; 0.100710290909091; 0.0989421333333333;
   0.0971444; 0.0953234285714286; 0.0934838666666667; 0.0916292;
   0.0897620941176471; 0.0878846222222222; 0.0859984210526316 |];

[| 0.106070342857143; 0.114985371428571; 0.116650114285714; 0.116502285714286;
   0.115629428571429; 0.114394057142857; 0.112951534693878; 0.111379542857143;
   0.109721238095238; 0.108002514285714; 0.106239849350649; 0.104444228571429;
   0.102623257142857; 0.100782367346939;0.0989255428571428;0.0970557714285714;
   0.095175337815126; 0.0932860190476191; 0.0913892180451128 |];

[| 0.1139892; 0.1215448; 0.1227564; 0.122382;
   0.1213732; 0.1200472; 0.118539942857143; 0.1169194;
   0.115223333333333; 0.1134744; 0.111687018181818; 0.1098708;
   0.1080324; 0.106176571428571; 0.1043068; 0.1024257;
   0.100535270588235; 0.0986370666666667; 0.0967323157894737 |];

[| 0.121303866666667; 0.127802133333333; 0.128661288888889; 0.128110666666667;
   0.126996133333333; 0.125599644444444; 0.124042038095238; 0.122383733333333;
   0.120658296296296; 0.118885866666667; 0.117079260606061; 0.115247022222222;
   0.113395066666667; 0.111527619047619; 0.109647777777778; 0.107757866666667;
   0.105859662745098; 0.103954548148148; 0.102043614035088 |];

[| 0.1281956; 0.133848; 0.1344252; 0.1337336;
   0.13253448; 0.1310816; 0.129483714285714; 0.1277952;
   0.126046266666667; 0.12425504; 0.122433054545455; 0.120588;
   0.1187252; 0.116848457142857; 0.11496056; 0.1130636;
   0.111159176470588; 0.109248533333333; 0.107332652631579 |];

[| 0.1411332; 0.1455168; 0.145671066666667; 0.144768;
   0.143442; 0.141904533333333; 0.140246228571429; 0.1385124;
   0.136728222222222; 0.1349088; 0.133063745454545; 0.131199466666667;
   0.1293204; 0.127429714285714; 0.125529733333333; 0.1236222;
   0.121708447058824; 0.119789511111111; 0.117866210526316 |];

[| 0.153345771428571; 0.156823085714286; 0.156675257142857; 0.155621142857143;
   0.154204514285714; 0.152606628571429; 0.150905167346939; 0.149138971428571;
   0.147329619047619; 0.145490057142857; 0.143628524675325; 0.141750514285714;
   0.139859828571429; 0.137959183673469; 0.136050571428571; 0.134135485714286;
   0.132215068907563; 0.13029020952381; 0.128361609022556 |];

[| 0.1651052; 0.1679028; 0.1675284; 0.166361;
   0.1648764; 0.1632332; 0.161499371428571; 0.1597089;
   0.157880666666667; 0.156026; 0.154152109090909; 0.1522638;
   0.1503644; 0.148456285714286; 0.1465412; 0.14462045;
   0.142695035294118; 0.140765733333333; 0.138833157894737 |];

[| 0.176562533333333; 0.178831466666667; 0.178280844444444; 0.177025333333333;
   0.175487866666667; 0.173809422222222; 0.172050419047619; 0.170241066666667;
   0.168398148148148; 0.166531733333333; 0.16464823030303; 0.162751911111111;
   0.160845733333333; 0.15893180952381; 0.157011688888889; 0.155086533333333;
   0.153157231372549; 0.151224474074074; 0.149288807017544 |];

[| 0.1878084; 0.1896544; 0.1889628; 0.1876368;
   0.18605704; 0.1843504; 0.182571257142857; 0.1807468;
   0.178892133333333; 0.17701632; 0.175125127272727; 0.1732224;
   0.1713108; 0.169392228571429; 0.16746808; 0.1655394;
   0.163606988235294; 0.161671466666667; 0.159733326315789 |]
|]

(* speed_est.(throt_vect).(press_vect) *)
let speed_est = [|
[| 471.83783972137; 279.608397864926; 203.371570611254; 161.8787486246;
   135.709492497923; 117.708903405276; 104.597552018818; 94.6535908661957;
   86.8841327758477; 80.675803186167; 75.3235987408633; 70.3050930321351;
   65.4742360253649; 60.6944949690365; 55.8207660907439; 50.6743433305652;
   44.9951652285928; 38.3189908260105; 29.5056655562855 |];

[| 550.809400909612; 330.673297375769; 242.26852873504; 193.747159084239;
   162.957551629386; 141.67966946265; 126.123496556834; 114.289217878186;
   105.018799398318; 97.594251566389; 91.1737064723463; 85.1299344960694;
   79.2906767636512; 73.4929197266039; 67.5611474923051; 61.2765189158975;
   54.3172285532483; 46.1040923733648; 35.2055605085197 |];

[| 777.559313277022; 480.417440799461; 358.002161788932; 289.574202279002;
   245.543311415534; 214.776328040985; 192.07791115253; 174.677692204617;
   160.956490038028; 149.902110578226; 140.278597740397; 131.153610171063;
   122.277816777847; 113.409376602425; 104.280991396472; 94.5509326446781;
   83.705557690075; 70.8031609873486; 53.4779650563955 |];

[| 1080.92434990449; 685.372101847464; 519.092057462468; 424.676170483973;
   363.145673048974; 319.692053974297; 287.341871164569; 262.345119103772;
   242.492868057991; 226.394217833907; 212.292318881674; 198.846293954267;
   185.702134732112; 172.50933166724; 158.871868276136; 144.272448006427;
   127.917919488172; 108.326912550372; 81.7063907826435 |];

[| 1418.36795322013; 916.851376256768; 703.229854643696; 580.603095221263;
   499.94000853881; 442.510230703477; 399.445507543738; 365.951590600047;
   339.189939777259; 317.364349597567; 298.151914987626; 279.764113706134;
   261.730873981831; 243.579971324357; 224.769448277835; 204.580168678984;
   181.892574292956; 154.583190885904; 117.117077445911 |];

[| 1769.74687680127; 1160.1314328424; 898.238993515751; 746.787807025315;
   646.508597012421; 574.688979015547; 520.541064714086; 478.214112005196;
   444.232947434523; 416.391492625875; 391.791212050025; 368.186625303754;
   344.988267957597; 321.598079997715; 297.322232877249; 271.229857827795;
   241.855607834812; 206.386960225754; 157.382577578816 |];

[| 2125.37309263935; 1407.76452438693; 1097.70378090141; 917.473659193288;
   797.577905876503; 711.335064829116; 646.047348388092; 594.814395514416;
   553.529203851986; 519.579183098854; 489.49454799578; 460.575760678401;
   432.114190611351; 403.385950235642; 373.544920238797; 341.447078245359;
   305.277093749081; 261.519584827818; 200.762546022977 |];

[| 2480.2034506654; 1655.75761978137; 1298.09727179509; 1089.42803425652;
   950.132739955284; 849.607686503322; 773.270213387776; 713.185295506684;
   664.623708146887; 624.572837364542; 589.001539364419; 554.764041929731;
   521.034310353426; 486.96446049424; 451.558173068746; 413.460864517961;
   370.510575211873; 318.492792975403; 246.018953244231 |];

[| 2831.37796793179; 1901.808662448; 1497.35579284241; 1260.73461790173;
   1102.36519097486; 987.786615401458; 900.564356309899; 831.747723593636;
   775.997173795666; 729.90798909099; 688.899853355633; 649.390617909572;
   610.439281589141; 571.076594684699; 530.15924252267; 486.126496205261;
   436.476678595697; 376.308590039311; 292.282778568289 |];

[| 3177.1400695945; 2144.49278527693; 1694.19192779751; 1430.18899233724;
   1253.13123223848; 1124.77668494257; 1026.87671228218; 949.48631941833;
   886.668843064165; 834.636155172288; 788.271994751692; 743.568579579048;
   699.472690135679; 654.89669774683; 608.553985624548; 558.6829023211;
   502.450584118529; 434.285750511691; 338.940084704028 |];

[| 3516.32917143061; 2382.86747403876; 1887.7517634672; 1596.98966759448;
   1401.66698241218; 1259.84425958553; 1151.49973350585; 1065.7170365502;
   995.976431700551; 938.115566892664; 886.49600271497; 836.695488732213;
   787.551488496573; 737.861144349535; 686.198444354019; 630.606384904028;
   567.930157525194; 491.94692760058; 385.549752105839 |];

[| 4064.90417866681; 2768.85858210137; 2201.51253250506; 1867.63164732177;
   1642.876281514; 1479.34457659158; 1354.15682962093; 1254.83174348032;
   1173.91065702869; 1106.62887811061; 1046.50914042027; 988.463841700913;
   931.154917867196; 873.194668518848; 812.933675618733; 748.102083629944;
   675.029769562251; 586.451209451461; 462.283276549317 |];

[| 5187.5536582049; 3559.93784568518; 2845.39982905067; 2423.68113893442;
   2138.9681302302; 1931.19988523555; 1771.6718372989; 1644.71499808623;
   1540.95928336809; 1454.41450439158; 1376.90154244357; 1301.9842835045;
   1227.9688874288; 1153.09356010507; 1075.25742272398; 991.559278287165;
   897.290333473879; 783.085471474455; 622.871451077645 |];

[| 7058.81244092784; 5120.07633362899; 3415.67249759347; 2916.59803777156;
   2579.08427916718; 2332.35229944546; 2142.56519552183; 1991.24652454498;
   1867.34355333296; 1763.78778377408; 1670.90629293198; 1581.08041514928;
   1492.30435551432; 1402.48876367426; 1309.13803889951; 1208.7997743787;
   1095.85957808202; 959.1242501394; 767.312631502771 |];

[| 7905.2133289905; 4857.30446816772; 3902.68104081193; 3337.74407341489;
   2955.27603074438; 2675.36755312393; 2459.81057943173; 2287.73814721368;
   2146.66511779659; 2028.60528678136; 1922.6162034325; 1820.07475630878;
   1718.71021507893; 1616.15528054261; 1509.57971328753; 1395.06422817669;
   1266.22809794773; 1110.33274165035; 891.700213222441 |];

[| 7710.468019974; 5340.4795211573; 5138.02264342828; 3678.54554042742;
   3259.7735758443; 2953.0713310185; 2716.69993582276; 2527.86174301408;
   2372.91490838085; 2243.13226748765; 2126.54721983279; 2013.72662779576;
   1902.18612791079; 1789.33441248671; 1672.07169888745; 1546.1028629502;
   1404.43064942514; 1233.07405756645; 992.823684550011 |];

[| 8213.01117303187; 5695.38659373278; 5427.47378987479; 3928.96042836635;
   3483.54542386244; 3941.97900226679; 2905.53071698226; 2704.38593216298;
   2539.25393459452; 2400.86384248306; 2276.49792356335; 2156.12907620045;
   2037.11629797167; 1916.70408848399; 1791.59516670388; 1657.21912691696;
   1506.12731593929; 1323.42949162775; 1067.33348108226 |]
|]

(* throt_est.(speed_vect).(press_vect) *)
let throt_est = [|
[| 0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0 |];

[| 0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 0.0;
   0.0; 6.38557183666741; 8.36078549102468 |];

[| 0.0; 0.0; 0.0; 0.0;
   0.0; 0.0; 0.0; 1.68952064775892;
   2.58459293118996; 0.0; 0.0; 0.0;
   0.0; 0.0; 5.72108728076961; 6.3750168521786;
   7.20563563331884; 8.39975976982351; 10.6117509444352 |];

[| 0.0; 0.0; 0.0; 0.0;
   0.0; 1.76802310777461; 2.92603728143597; 3.68765265549568;
   4.2827107614983; 0.0; 0.0; 0.0;
   6.14796400589012; 6.65737848247362; 7.23481380756777; 7.92705115220155;
   8.82334793593341; 10.1353075311753; 12.6118337694851 |];

[| 0.0; 0.0; 0.0; 0.0;
   2.23554727549034; 3.45390489695181; 4.29428243321988; 4.96177408946325;
   5.52152437709265; 6.00442951618664; 6.45575287330264; 6.91762377708157;
   7.40645853591457; 7.94329727562219; 8.55895105992222; 9.30473054681604;
   10.2797398746146; 11.7206270987892; 14.4699904584988 |];

[| 0.0; 0.0; 0.0; 2.00945116292016;
   3.56980410482401; 4.57394930642981; 5.35854644463211; 6.01267023811018;
   6.57608118903583; 7.07068982618833; 7.53897649948701; 8.02325885387935;
   8.54037682418046; 9.11265211291579; 9.77342385955991; 10.5788305954593;
   11.6379994274808; 13.2126634608191; 16.2388908630509 |];

[| 0.0; 0.0; 0.0; 3.26512675748984;
   4.54951864911428; 5.50260885317693; 6.28151203903057; 6.9460898992458;
   7.52690613968154; 8.04209592063777; 8.53383677876633; 9.04579246774152;
   9.59562216583646; 10.2071832656666; 10.9165151191999; 11.7847066269243;
   12.9310015111071; 14.6423143468311; 17.9485618603934 |];

[| 0.0; 0.0; 3.26939890783266; 4.93993697812215;
   6.12848554855993; 7.08785924601728; 7.9029323976024; 8.61479491409082;
   9.2470988876756; 9.81495020245894; 10.3624457435875; 10.9372309946699;
   11.559048172117; 12.255137310414; 13.0671803261239; 14.0663919749844;
   15.3925393313355; 17.3835353180801; 21.2600727314813 |];

[| 0.0; 1.97904504866644; 4.68685315248027; 6.25862088648567;
   7.47141627043916; 8.48241463509671; 9.35722587042053; 10.1307970128162;
   10.8243913695934; 11.4520950956594; 12.0611893426105; 12.7040053932019;
   13.4026283719018; 14.1878941036806; 15.1073406829871; 16.2425902389803;
   17.7544477915884; 20.0332049014743; 24.4970795821847 |];

[| 0.0; 3.49935436615977; 5.83082912179049; 7.42063295143371;
   8.6925289781201; 9.77170752982322; 10.7159817812692; 11.5577750193981;
   12.3174528597223; 13.008803044849; 13.6828060700106; 14.396806156051;
   15.1753752467028; 16.0530950529225; 17.0835569566403; 18.3591169978511;
   20.0623044346245; 22.637737086943; 27.7107066047989 |];

[| 0.0; 4.57612627196189; 6.84534682782423; 8.49318969125795;
   9.83954920575794; 10.9951302867449; 12.0141451285679; 12.9279899720331;
   13.7567936325807; 14.5143792471273; 15.2557024704959; 16.0433290287536;
   16.9044303761244; 17.8774756101994; 19.0223242159663; 20.4424553066756;
   22.3429785904355; 25.2253182760044; 30.9341446513223 |];

[| 0.0; 5.4899869374105; 7.78334848286328; 9.50824639884044;
   10.9374933516508; 12.1744338663107; 13.2716480112421; 14.2602579413105;
   15.1605017586539; 15.9864169636978; 16.7971152572272; 17.6605500704427;
   18.6065984454004; 19.677765839258; 20.9404225932695; 22.5096284613761;
   24.6141026645188; 27.8151016031611; 34.1919954252064 |];

[| 1.88135273591948; 6.31516301504729; 8.67098690951994; 10.4837670252906;
   12.0012600728996; 13.3230077085424; 14.5010295041136; 15.5666018297716;
   16.5402737876564; 17.4364027833076; 18.3183955169832; 19.2597456088894;
   20.2931446720398; 21.4652976435462; 22.8493616297414; 24.5725086161537;
   26.8882811653654; 30.4213918236144; 37.504774338111 |];

[| 3.79849600229045; 7.8143453304318; 10.3498113351197; 12.3572436949325;
   14.0618374770048; 15.5608133318763; 16.9067731149248; 18.1320061284013;
   19.2580207189374; 20.2999910166858; 21.3302663163972; 22.4338810423488;
   23.6495165775918; 25.0328421524519; 26.6715719766891; 28.7190355532134;
   31.4829183963948; 35.7285995578245; 44.371432875346 |];

[| 5.11555629372529; 9.19732422785629; 11.9492443997711; 14.1668720034946;
   16.0687142799863; 17.7531415761398; 19.2745192692445; 20.6666509650554;
   21.9522461670901; 23.1474215110058; 24.3339174774984; 25.6089808801288;
   27.0178479496848; 28.6260675176708; 30.5375409305631; 32.9350270586942;
   36.1881555417967; 41.2277477056535; 51.6991471191527 |];

[| 6.24242295476299; 10.5135378018799; 13.5020175722867; 15.9404757448486;
   18.0477414534266; 19.9250387905807; 21.6291037798254; 23.1955175631949;
   24.6483184159076; 26.0046309530839; 27.3560645640754; 28.8128629411026;
   30.4275204239407; 32.2766345290121; 34.4824245581978; 37.2614676418117;
   41.0561700114902; 46.9991894427332; 59.7145600188598 |];

[| 7.27207202821189; 11.7881627211469; 15.0266793865412; 17.6946205311027;
   20.0148343673189; 22.0923611407587; 23.9866631108049; 25.7352575608424;
   27.3635907811683; 28.8898376231783; 30.4160196605077; 32.0663185268805;
   33.9013810420667; 36.0103736823143; 38.5366722900452; 41.7366991530738;
   46.1411752613639; 53.1408741058761; 68.8121019668407 |];

[| 8.24307752438666; 13.0358730041026; 16.5348533930163; 19.4401179418127;
   21.9807248385761; 24.2661341475978; 26.3587689895536; 28.2981951067231;
   30.1113294030184; 31.8174363088206; 33.5295893568537; 35.3870586461495;
   37.4598056380896; 39.8515879531095; 42.7308211151926; 46.402332172253;
   51.5085029877518; 59.7919671468469; 79.9040315711675 |]
|]

let init2d l1 l2 f =
  let fr x = Array.init l2 (fun y -> f (x, y)) in
  Array.init l1 fr

let ki = 0.012
let ramp_rate_kix = Lookup.regular_int_breakpoints   100 100 600
let ramp_rate_kiy = Lookup.regular_float_breakpoints 0.0 0.2 1.0
let ramp_rate_kiz =
  let f (x, y) = float ((x + 1) * (y + 1)) *. ki in
  init2d 6 6 f

let int_breakpoints   = Lookup.int_breakpoints   (Lookup.LinearLookup, true)
let float_breakpoints = Lookup.float_breakpoints (Lookup.LinearLookup, true)

let dump2d filename (bpl1, bps1, to_dist1) (bpl2, bps2, to_dist2) table =
  let outp = open_out filename
  and f = Lookup.float_make_lookup_2d
    bpl1
    bpl2
    (Lookup.LinearInterpolation true)
    (Lookup.LinearInterpolation true)
    bps1
    bps2
    table
    (function x -> x)
  in
  (Lookup.test_2d
    (to_dist1 3 bps1)
    (function x -> x)
    (to_dist2 3 bps2)
    (function x -> x)
    outp
    f;
   close_out outp)

let dump_data () =
  let speed = (int_breakpoints, speed_vect,
               Lookup.int_breakpoints_to_test_dist)
  and throt = (int_breakpoints, throt_vect,
               Lookup.int_breakpoints_to_test_dist)
  and press = (float_breakpoints, press_vect,
               Lookup.float_breakpoints_to_test_dist)
  in
  dump2d "press_est.log" speed throt press_est;
  dump2d "pump_con.log" speed press pump_con;
  dump2d "speed_est.log" throt press speed_est;
  dump2d "throt_est.log" speed press throt_est

(* let _ = dump_data () *)

(*
    gnuplot -persist:

    press_est.log:
        set grid
        set xlabel 'Speed'
        set xrange [30:1020]
        set ylabel 'Throttle'
        set yrange [-10:100]
        set zlabel 'Pressure'
        set title 'press_est'
        splot 'press_est.log'

    pump_con.log:
        set grid
        set xlabel 'Speed'
        set xrange [30:1020]
        set ylabel 'Pressure'
        set yrange [-0.05:1.0]
        set zlabel 'Pump Con'
        set title 'pump_con'
        splot 'pump_con.log'

    speed_est.log:
        set grid
        set xlabel 'Throttle'
        set xrange [-10:100]
        set ylabel 'Pressure'
        set yrange [-0.05:1.0]
        set zlabel 'Speed'
        set title 'speed_est'
        splot 'speed_est.log'

    throt_est.log:
        set grid
        set xlabel 'Speed'
        set xrange [30:1020]
        set ylabel 'Pressure'
        set yrange [-0.05:1.0]
        set zlabel 'Throttle'
        set title 'throt_est'
        splot 'throt_est.log'
 *)
